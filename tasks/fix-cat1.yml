---
- name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself."
  block:
    - name: Single Router Setup Block.
      block:
        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | No ACL Defined Warning Message."
          debug:
            msg: 
              - "Warning!!! Review the external and internal Access Control Lists (ACLs) to verify that the router is configured to only allow specific management and control plane traffic from specific sources destined to itself."
              - "To Fix this error please define a existing ACL in iosrtr_external_exisiting_acl in defaults main."
          when:
            - "'none' in iosrtr_external_existing_acl"
            - not cisc_rt_hardening_one_device

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Create Control Warning For End Of Play."
          set_fact:
            control_number:
              - "{{ control_number }} + [ CISC-RT-000130 - You Have Not Entered External ACL Name ]"
            warn_count: "{{ warn_count|int + 1 }}"
          when:
            - "'none' in iosrtr_external_existing_acl"
            - not cisc_rt_hardening_one_device

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself.| No ACL Defined Warning Message."
          debug:
            msg: 
              - "Warning!!! Review the external and internal Access Control Lists (ACLs) to verify that the router is configured to only allow specific management and control plane traffic from specific sources destined to itself."
              - "To Fix this error please define a existing ACL in iosrtr_internal_exisiting_acl in defaults main."
          when:
            - "'none' in iosrtr_internal_existing_acl"
            - not cisc_rt_hardening_one_device

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Create Control Warning For End Of Play."
          set_fact:
            control_number:
              - "{{ control_number }} + [ CISC-RT-000130 - You Have Not Entered Internal ACL Name ]"
            warn_count: "{{ warn_count|int + 1 }}"
          when:
            - "'none' in iosrtr_internal_existing_acl"
            - not cisc_rt_hardening_one_device

    - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | User Defined (Existing ACL) In Defaults Main Or Template."
      block:
        - name: Show Run Existing External ACL."
          ios_command:
            commands:
              - "show run | section ip access-list extended {{ iosrtr_external_existing_acl }}"
          register: cisc_rt_000130_acl_showrun_external_existing
          when:
            - "'none' not in iosrtr_external_existing_acl"

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Show Run Existing Internal ACL."
          ios_command:
            commands:
              - "show run | section ip access-list extended {{ iosrtr_internal_existing_acl }}"
          register: cisc_rt_000130_acl_showrun_internal_existing
          when:
            - "'none' not in iosrtr_internal_existing_acl"

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | No ACL Defined By That Name Warning iosrtr_external_existing_acl."
          debug:
            msg: 
              - "Warning!!! Review the external Access Control Lists (ACLs) to verify that the router is configured to only allow specific management and control plane traffic from specific sources destined to itself."
              - "The defined ACL {{ item }} is not present on the Router and must be configured in iosrtr_external_existing_acl."
          when:
            - item not in cisc_rt_000130_acl_showrun_external_existing.stdout | string
            - "'none' not in iosrtr_external_existing_acl"
          with_items:
            - "{{ iosrtr_external_existing_acl }}"

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Create Control Warning For End Of Play iosrtr_external_existing_acl."
          set_fact:
            control_number:
              - "{{ control_number }} + [ CISC-RT-000130 - User Defined (Existing ACL) {{ item }} Not Present ]"
            warn_count: "{{ warn_count|int + 1 }}"
          when:
            - item not in cisc_rt_000130_acl_showrun_external_existing.stdout | string
            - "'none' not in iosrtr_external_existing_acl"
          with_items:
            - "{{ iosrtr_external_existing_acl }}"

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. |  No ACL Defined By That Name Warning iosrtr_internal_existing_acl." 
          debug:
            msg: 
              - "Warning!!! Review the internal Access Control Lists (ACLs) to verify that the router is configured to only allow specific management and control plane traffic from specific sources destined to itself."
              - "The defined ACL {{ item }} is not present on the Router and must be configured in iosrtr_internal_existing_acl."
          when:
            - "'none' not in iosrtr_internal_existing_acl"
            - item not in cisc_rt_000130_acl_showrun_internal_existing.stdout | string
          with_items:
            - "{{ iosrtr_internal_existing_acl }}"

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Create Control Warning For End Of Play iosrtr_internal_existing_acl."
          set_fact:
            control_number:
              - "{{ control_number }} + [ CISC-RT-000130 - User Defined (Existing ACL) {{ item }} Not Present ]"
            warn_count: "{{ warn_count|int + 1 }}"
          when:
            - "'none' not in iosrtr_internal_existing_acl"
            - item not in cisc_rt_000130_acl_showrun_internal_existing.stdout | string
          with_items:
            - "{{ iosrtr_internal_existing_acl }}"

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Gather Interface Facts."
          ios_interfaces:
            state: gathered
          register: cisc_rt_000130_interfaceinfo
          when:
            - iosrtr_external_existing_acl in cisc_rt_000130_acl_showrun_external_existing.stdout | string or iosrtr_internal_existing_acl in cisc_rt_000130_acl_showrun_internal_existing.stdout | string

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Register Show Run With Interfaces."
          ios_command:
            commands: 
              - "show run | section {{ item.name }}" 
          with_items: "{{ cisc_rt_000130_interfaceinfo.gathered }}"
          register: cisc_rt_000130_interfaceinfo_showrun
          when:
            - iosrtr_external_existing_acl in cisc_rt_000130_acl_showrun_external_existing.stdout | string or iosrtr_internal_existing_acl in cisc_rt_000130_acl_showrun_internal_existing.stdout | string

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Set Fact For Interface Name And Interface Stdout." 
          set_fact:
            cisc_rt_000130_intname: "{{ cisc_rt_000130_interfaceinfo_showrun.results | map(attribute='item.name') }}"
            cisc_rt_000130_intstdout: "{{ cisc_rt_000130_interfaceinfo_showrun.results | map(attribute='stdout') }}"
          when:
            - iosrtr_external_existing_acl in cisc_rt_000130_acl_showrun_external_existing.stdout | string or iosrtr_internal_existing_acl in cisc_rt_000130_acl_showrun_internal_existing.stdout | string

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Set Fact For External ACL Lines."
          set_fact:
            cisc_rt_000130_ext_acl_line_1: permit tcp host {{ item.source_host }} eq bgp host {{ item.destination_host }}
            cisc_rt_000130_ext_acl_line_2: permit tcp host {{ item.source_host }} host {{ item.destination_host }} eq bgp
            cisc_rt_000130_ext_acl_line_3: permit icmp host {{ item.source_host }} host {{ item.destination_host }} echo
            cisc_rt_000130_ext_acl_line_4: permit icmp host {{ item.source_host }} host {{ item.destination_host }} echo-reply
            cisc_rt_000130_ext_acl_line_5: deny   ip any host {{ item.source_host }} log-input
            cisc_rt_000130_ext_acl_line_6: deny   ip any any log-input
          with_items:
            - "{{ iosrtr_external_acl_addresses }}"
          when:
            - "'none' not in iosrtr_external_existing_acl"
            - iosrtr_external_existing_acl in cisc_rt_000130_acl_showrun_external_existing.stdout | string

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Check External ACL For Compliance Using iosrtr_external_acl_addresses Line 1."
          debug:
            msg: 
              - "Warning!!! Review {{ iosrtr_external_existing_acl }} Access Control Lists (ACLs)."
              - "permit tcp host {{ item.source_host }} eq bgp host {{ item.destination_host }} has not been added to the ACL."
          when:
            - "'none' not in iosrtr_external_existing_acl"
            - iosrtr_external_existing_acl in cisc_rt_000130_acl_showrun_external_existing.stdout | string
            - cisc_rt_000130_ext_acl_line_1 not in cisc_rt_000130_acl_showrun_external_existing.stdout_lines | string
          with_items:
            - "{{ iosrtr_external_acl_addresses }}"

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Create Control Warning For End Of Play iosrtr_external_acl_addresses Line 1."
          set_fact:
            control_number:
              - "{{ control_number }} + [ CISC-RT-000130 - {{ iosrtr_external_existing_acl }} permit tcp host {{ item.source_host }} eq bgp host {{ item.destination_host }} Not Present ]"
            warn_count: "{{ warn_count|int + 1 }}"
          when:
            - "'none' not in iosrtr_external_existing_acl"
            - iosrtr_external_existing_acl in cisc_rt_000130_acl_showrun_external_existing.stdout | string
            - cisc_rt_000130_ext_acl_line_1 not in cisc_rt_000130_acl_showrun_external_existing.stdout_lines | string
          with_items:
            - "{{ iosrtr_external_acl_addresses }}"
            
        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Check External ACL For Compliance Using iosrtr_external_acl_addresses Line 2."
          debug:
            msg: 
              - "Warning!!! Review {{ iosrtr_external_existing_acl }} Access Control Lists (ACLs)."
              - "permit tcp host {{ item.source_host }} host {{ item.destination_host }} eq bgp has not been added to the ACL."
          when:
            - "'none' not in iosrtr_external_existing_acl"
            - iosrtr_external_existing_acl in cisc_rt_000130_acl_showrun_external_existing.stdout | string
            - cisc_rt_000130_ext_acl_line_2 not in cisc_rt_000130_acl_showrun_external_existing.stdout_lines | string
          with_items:
            - "{{ iosrtr_external_acl_addresses }}"

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Create Control Warning For End Of Play iosrtr_external_acl_addresses Line 2."
          set_fact:
            control_number:
              - "{{ control_number }} + [ CISC-RT-000130 - {{ iosrtr_external_existing_acl }} permit tcp host {{ item.source_host }} host {{ item.destination_host }} eq bgp Not Present ]"
            warn_count: "{{ warn_count|int + 1 }}"
          when:
            - "'none' not in iosrtr_external_existing_acl"
            - iosrtr_external_existing_acl in cisc_rt_000130_acl_showrun_external_existing.stdout | string
            - cisc_rt_000130_ext_acl_line_2 not in cisc_rt_000130_acl_showrun_external_existing.stdout_lines | string
          with_items:
            - "{{ iosrtr_external_acl_addresses }}"

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Check External ACL For Compliance Using iosrtr_external_acl_addresses Line 3."
          debug:
            msg: 
              - "Warning!!! Review {{ iosrtr_external_existing_acl }} Access Control Lists (ACLs)."
              - "permit icmp host {{ item.source_host }} host {{ item.destination_host }} echo has not been added to the ACL."
          when:
            - "'none' not in iosrtr_external_existing_acl"
            - iosrtr_external_existing_acl in cisc_rt_000130_acl_showrun_external_existing.stdout | string
            - cisc_rt_000130_ext_acl_line_3 not in cisc_rt_000130_acl_showrun_external_existing.stdout_lines | string
          with_items:
            - "{{ iosrtr_external_acl_addresses }}"

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Create Control Warning For End Of Play iosrtr_external_acl_addresses Line 3."
          set_fact:
            control_number:
              - "{{ control_number }} + [ CISC-RT-000130 - {{ iosrtr_external_existing_acl }} permit icmp host {{ item.source_host }} host {{ item.destination_host }} echo Not Present ]"
            warn_count: "{{ warn_count|int + 1 }}"
          when:
            - "'none' not in iosrtr_external_existing_acl"
            - iosrtr_external_existing_acl in cisc_rt_000130_acl_showrun_external_existing.stdout | string
            - cisc_rt_000130_ext_acl_line_3 not in cisc_rt_000130_acl_showrun_external_existing.stdout_lines | string
          with_items:
            - "{{ iosrtr_external_acl_addresses }}"
          
        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Check External ACL For Compliance Using iosrtr_external_acl_addresses Line 4."
          debug:
            msg: 
              - "Warning!!! Review {{ iosrtr_external_existing_acl }} Access Control Lists (ACLs)."
              - "permit icmp host {{ item.source_host }} host {{ item.destination_host }} echo-reply has not been added to the ACL."
          when:
            - "'none' not in iosrtr_external_existing_acl"
            - iosrtr_external_existing_acl in cisc_rt_000130_acl_showrun_external_existing.stdout | string
            - cisc_rt_000130_ext_acl_line_4 not in cisc_rt_000130_acl_showrun_external_existing.stdout_lines | string
          with_items:
            - "{{ iosrtr_external_acl_addresses }}"

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Create Control Warning For End Of Play iosrtr_external_acl_addresses Line 4."
          set_fact:
            control_number:
              - "{{ control_number }} + [ CISC-RT-000130 - {{ iosrtr_external_existing_acl }} permit icmp host {{ item.source_host }} host {{ item.destination_host }} echo-reply Not Present ]"
            warn_count: "{{ warn_count|int + 1 }}"
          when:
            - "'none' not in iosrtr_external_existing_acl"
            - iosrtr_external_existing_acl in cisc_rt_000130_acl_showrun_external_existing.stdout | string
            - cisc_rt_000130_ext_acl_line_4 not in cisc_rt_000130_acl_showrun_external_existing.stdout_lines | string
          with_items:
            - "{{ iosrtr_external_acl_addresses }}"

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Check External ACL For Compliance Using iosrtr_external_acl_addresses Line 5."
          debug:
            msg: 
              - "Warning!!! Review {{ iosrtr_external_existing_acl }} Access Control Lists (ACLs)."
              - "deny ip any host {{ item.source_host }} log-input has not been added to the ACL."
          when:
            - "'none' not in iosrtr_external_existing_acl"
            - iosrtr_external_existing_acl in cisc_rt_000130_acl_showrun_external_existing.stdout | string
            - cisc_rt_000130_ext_acl_line_5 not in cisc_rt_000130_acl_showrun_external_existing.stdout_lines | string
          with_items:
            - "{{ iosrtr_external_acl_addresses }}"

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Create Control Warning For End Of Play iosrtr_external_acl_addresses Line 5."
          set_fact:
            control_number:
              - "{{ control_number }} + [ CISC-RT-000130 - {{ iosrtr_external_existing_acl }} deny ip any host {{ item.source_host }} log-input Not Present ]"
            warn_count: "{{ warn_count|int + 1 }}"
          when:
            - "'none' not in iosrtr_external_existing_acl"
            - iosrtr_external_existing_acl in cisc_rt_000130_acl_showrun_external_existing.stdout | string
            - cisc_rt_000130_ext_acl_line_5 not in cisc_rt_000130_acl_showrun_external_existing.stdout_lines | string
          with_items:
            - "{{ iosrtr_external_acl_addresses }}"

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Check External ACL For Compliance Using iosrtr_external_acl_addresses Line 6."
          debug:
            msg: 
              - "Warning!!! Review {{ iosrtr_external_existing_acl }} Access Control Lists (ACLs)."
              - "deny ip any any log-input has not been added to the ACL."
          when:
            - "'none' not in iosrtr_external_existing_acl"
            - iosrtr_external_existing_acl in cisc_rt_000130_acl_showrun_external_existing.stdout | string
            - cisc_rt_000130_ext_acl_line_6 not in cisc_rt_000130_acl_showrun_external_existing.stdout_lines | string
          with_items:
            - "{{ iosrtr_external_acl_addresses }}"

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Create Control Warning For End Of Play iosrtr_external_acl_addresses Line 6."
          set_fact:
            control_number:
              - "{{ control_number }} + [ CISC-RT-000130 - {{ iosrtr_external_existing_acl }} deny ip any any log-input Not Present At End Of ACL ]"
            warn_count: "{{ warn_count|int + 1 }}"
          when:
            - "'none' not in iosrtr_external_existing_acl"
            - iosrtr_external_existing_acl in cisc_rt_000130_acl_showrun_external_existing.stdout | string
            - cisc_rt_000130_ext_acl_line_6 not in cisc_rt_000130_acl_showrun_external_existing.stdout_lines | string
          with_items:
            - "{{ iosrtr_external_acl_addresses }}"

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Set Fact For Internal ACL Lines."
          set_fact:
            cisc_rt_000130_int_acl_line_1: permit icmp any any
            cisc_rt_000130_int_acl_line_2: permit ospf host {{ item.source_host }} host {{ item.destination_host }}
            cisc_rt_000130_int_acl_line_3: permit tcp {{ item.source_host }} {{ item.source_wildcard_bits }} host {{ item.destination_host }} eq 22
            cisc_rt_000130_int_acl_line_4: permit tcp {{ item.source_host }} {{ item.source_wildcard_bits }} host {{ item.destination_host }} eq tacacs
            cisc_rt_000130_int_acl_line_5: permit udp {{ item.source_host }} {{ item.source_wildcard_bits }} host {{ item.destination_host }} eq snmp
            cisc_rt_000130_int_acl_line_6: permit udp {{ item.source_host }} {{ item.source_wildcard_bits }} host {{ item.destination_host }} eq ntp
            cisc_rt_000130_int_acl_line_7: deny   ip any host {{ item.destination_host }} log-input
            cisc_rt_000130_int_acl_line_8: deny   ip any any log-input
          with_items:
            - "{{ iosrtr_internal_acl_addresses }}"
          when:
            - "'none' not in iosrtr_internal_existing_acl"
            - iosrtr_internal_existing_acl in cisc_rt_000130_acl_showrun_internal_existing.stdout | string

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Check Internal ACL For Compliance Using iosrtr_internal_acl_addresses Line 1."
          debug:
            msg: 
              - "Warning!!! Review {{ iosrtr_internal_existing_acl }} Access Control Lists (ACLs)."
              - "permit icmp any any has not been added to the ACL."
          when:
            - "'none' not in iosrtr_internal_existing_acl"
            - iosrtr_internal_existing_acl in cisc_rt_000130_acl_showrun_internal_existing.stdout | string
            - cisc_rt_000130_int_acl_line_1 not in cisc_rt_000130_acl_showrun_internal_existing.stdout_lines | string
          with_items:
            - "{{ iosrtr_internal_acl_addresses }}"

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Create Control Warning For End Of Play iosrtr_internal_acl_addresses Line 1."
          set_fact:
            control_number:
              - "{{ control_number }} + [ CISC-RT-000130 - {{ iosrtr_internal_existing_acl }} permit icmp any any Not Present ]"
            warn_count: "{{ warn_count|int + 1 }}"
          when:
            - "'none' not in iosrtr_internal_existing_acl"
            - iosrtr_internal_existing_acl in cisc_rt_000130_acl_showrun_internal_existing.stdout | string
            - cisc_rt_000130_int_acl_line_1 not in cisc_rt_000130_acl_showrun_internal_existing.stdout_lines | string
          with_items:
            - "{{ iosrtr_internal_acl_addresses }}"

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Check Internal ACL For Compliance Using iosrtr_internal_acl_addresses Line 2."
          debug:
            msg: 
              - "Warning!!! Review {{ iosrtr_internal_existing_acl }} Access Control Lists (ACLs)."
              - "permit ospf host {{ item.source_host }} host {{ item.destination_host }} has not been added to the ACL." 
          when:
            - "'none' not in iosrtr_internal_existing_acl"
            - iosrtr_internal_existing_acl in cisc_rt_000130_acl_showrun_internal_existing.stdout | string
            - cisc_rt_000130_int_acl_line_2 not in cisc_rt_000130_acl_showrun_internal_existing.stdout_lines | string
          with_items:
            - "{{ iosrtr_internal_acl_addresses }}"

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Create Control Warning For End Of Play iosrtr_internal_acl_addresses Line 2."
          set_fact:
            control_number:
              - "{{ control_number }} + [ CISC-RT-000130 - {{ iosrtr_internal_existing_acl }} permit ospf host {{ item.source_host }} host {{ item.destination_host }} Not Present ]"
            warn_count: "{{ warn_count|int + 1 }}"
          when:
            - "'none' not in iosrtr_internal_existing_acl"
            - iosrtr_internal_existing_acl in cisc_rt_000130_acl_showrun_internal_existing.stdout | string
            - cisc_rt_000130_int_acl_line_2 not in cisc_rt_000130_acl_showrun_internal_existing.stdout_lines | string
          with_items:
            - "{{ iosrtr_internal_acl_addresses }}"

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Check Internal ACL For Compliance Using iosrtr_internal_acl_addresses Line 3."
          debug:
            msg: 
              - "Warning!!! Review {{ iosrtr_internal_existing_acl }} Access Control Lists (ACLs)."
              - "permit tcp {{ item.source_host }} {{ item.source_wildcard_bits }} host {{ item.destination_host }} eq 22 has not been added to the ACL."
          when:
            - "'none' not in iosrtr_internal_existing_acl"
            - iosrtr_internal_existing_acl in cisc_rt_000130_acl_showrun_internal_existing.stdout | string
            - cisc_rt_000130_int_acl_line_3 not in cisc_rt_000130_acl_showrun_internal_existing.stdout_lines | string
          with_items:
            - "{{ iosrtr_internal_acl_addresses }}"

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Create Control Warning For End Of Play iosrtr_internal_acl_addresses Line 3."
          set_fact:
            control_number:
              - "{{ control_number }} + [ CISC-RT-000130 - {{ iosrtr_internal_existing_acl }} permit tcp {{ item.source_host }} {{ item.source_wildcard_bits }} host {{ item.destination_host }} eq 22 Not Present ]"
            warn_count: "{{ warn_count|int + 1 }}"
          when:
            - "'none' not in iosrtr_internal_existing_acl"
            - iosrtr_internal_existing_acl in cisc_rt_000130_acl_showrun_internal_existing.stdout | string
            - cisc_rt_000130_int_acl_line_3 not in cisc_rt_000130_acl_showrun_internal_existing.stdout_lines | string
          with_items:
            - "{{ iosrtr_internal_acl_addresses }}"

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Check Internal ACL For Compliance Using iosrtr_internal_acl_addresses Line 4."
          debug:
            msg: 
              - "Warning!!! Review {{ iosrtr_internal_existing_acl }} Access Control Lists (ACLs)."
              - "permit tcp {{ item.source_host }} {{ item.source_wildcard_bits }} host {{ item.destination_host }} eq tacacs has not been added to the ACL."
          when:
            - "'none' not in iosrtr_internal_existing_acl"
            - iosrtr_internal_existing_acl in cisc_rt_000130_acl_showrun_internal_existing.stdout | string
            - cisc_rt_000130_int_acl_line_4 not in cisc_rt_000130_acl_showrun_internal_existing.stdout_lines | string
          with_items:
            - "{{ iosrtr_internal_acl_addresses }}"

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Create Control Warning For End Of Play iosrtr_internal_acl_addresses Line 4."
          set_fact:
            control_number:
              - "{{ control_number }} + [ CISC-RT-000130 - {{ iosrtr_internal_existing_acl }} permit tcp {{ item.source_host }} {{ item.source_wildcard_bits }} host {{ item.destination_host }} eq tacacs Not Present ]"
            warn_count: "{{ warn_count|int + 1 }}"
          when:
            - "'none' not in iosrtr_internal_existing_acl"
            - iosrtr_internal_existing_acl in cisc_rt_000130_acl_showrun_internal_existing.stdout | string
            - cisc_rt_000130_int_acl_line_4 not in cisc_rt_000130_acl_showrun_internal_existing.stdout_lines | string
          with_items:
            - "{{ iosrtr_internal_acl_addresses }}"

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Check Internal ACL For Compliance Using iosrtr_internal_acl_addresses Line 5."
          debug:
            msg: 
              - "Warning!!! Review {{ iosrtr_internal_existing_acl }} Access Control Lists (ACLs)."
              - "permit udp {{ item.source_host }} {{ item.source_wildcard_bits }} host {{ item.destination_host }} eq snmp has not been added to the ACL."
          when:
            - "'none' not in iosrtr_internal_existing_acl"
            - iosrtr_internal_existing_acl in cisc_rt_000130_acl_showrun_internal_existing.stdout | string
            - cisc_rt_000130_int_acl_line_5 not in cisc_rt_000130_acl_showrun_internal_existing.stdout_lines | string
          with_items:
            - "{{ iosrtr_internal_acl_addresses }}"

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Create Control Warning For End Of Play iosrtr_internal_acl_addresses Line 5."
          set_fact:
            control_number:
              - "{{ control_number }} + [ CISC-RT-000130 - {{ iosrtr_internal_existing_acl }} permit udp {{ item.source_host }} {{ item.source_wildcard_bits }} host {{ item.destination_host }} eq snmp Not Present ]"
            warn_count: "{{ warn_count|int + 1 }}"
          when:
            - "'none' not in iosrtr_internal_existing_acl"
            - iosrtr_internal_existing_acl in cisc_rt_000130_acl_showrun_internal_existing.stdout | string
            - cisc_rt_000130_int_acl_line_5 not in cisc_rt_000130_acl_showrun_internal_existing.stdout_lines | string
          with_items:
            - "{{ iosrtr_internal_acl_addresses }}"

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Check Internal ACL For Compliance Using iosrtr_internal_acl_addresses Line 6."
          debug:
            msg: 
              - "Warning!!! Review {{ iosrtr_internal_existing_acl }} Access Control Lists (ACLs)."
              - "permit udp {{ item.source_host }} {{ item.source_wildcard_bits }} host {{ item.destination_host }} eq ntp has not been added to the ACL."
          when:
            - "'none' not in iosrtr_internal_existing_acl"
            - iosrtr_internal_existing_acl in cisc_rt_000130_acl_showrun_internal_existing.stdout | string
            - cisc_rt_000130_int_acl_line_6 not in cisc_rt_000130_acl_showrun_internal_existing.stdout_lines | string
          with_items:
            - "{{ iosrtr_internal_acl_addresses }}"

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Create Control Warning For End Of Play iosrtr_internal_acl_addresses Line 6."
          set_fact:
            control_number:
              - "{{ control_number }} + [ CISC-RT-000130 - {{ iosrtr_internal_existing_acl }} permit udp {{ item.source_host }} {{ item.source_wildcard_bits }} host {{ item.destination_host }} eq ntp Not Present ]"
            warn_count: "{{ warn_count|int + 1 }}"
          when:
            - "'none' not in iosrtr_internal_existing_acl"
            - iosrtr_internal_existing_acl in cisc_rt_000130_acl_showrun_internal_existing.stdout | string
            - cisc_rt_000130_int_acl_line_6 not in cisc_rt_000130_acl_showrun_internal_existing.stdout_lines | string
          with_items:
            - "{{ iosrtr_internal_acl_addresses }}"

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Check Internal ACL For Compliance Using iosrtr_internal_acl_addresses Line 7."
          debug:
            msg: 
              - "Warning!!! Review {{ iosrtr_internal_existing_acl }} Access Control Lists (ACLs)."
              - "deny   ip any host {{ item.destination_host }} log-input has not been added to the ACL."
          when:
            - "'none' not in iosrtr_internal_existing_acl"
            - iosrtr_internal_existing_acl in cisc_rt_000130_acl_showrun_internal_existing.stdout | string
            - cisc_rt_000130_int_acl_line_7 not in cisc_rt_000130_acl_showrun_internal_existing.stdout_lines | string
          with_items:
            - "{{ iosrtr_internal_acl_addresses }}"

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Create Control Warning For End Of Play iosrtr_internal_acl_addresses Line 7."
          set_fact:
            control_number:
              - "{{ control_number }} + [ CISC-RT-000130 - {{ iosrtr_internal_existing_acl }} deny   ip any host {{ item.destination_host }} log-input Not Present ]"
            warn_count: "{{ warn_count|int + 1 }}"
          when:
            - "'none' not in iosrtr_internal_existing_acl"
            - iosrtr_internal_existing_acl in cisc_rt_000130_acl_showrun_internal_existing.stdout | string
            - cisc_rt_000130_int_acl_line_7 not in cisc_rt_000130_acl_showrun_internal_existing.stdout_lines | string
          with_items:
            - "{{ iosrtr_internal_acl_addresses }}"

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Check Internal ACL For Compliance Using iosrtr_internal_acl_addresses Line 8."
          debug:
            msg: 
              - "Warning!!! Review {{ iosrtr_internal_existing_acl }} Access Control Lists (ACLs)."
              - "deny   ip any any log-input has not been added to the ACL."
          when:
            - "'none' not in iosrtr_internal_existing_acl"
            - iosrtr_internal_existing_acl in cisc_rt_000130_acl_showrun_internal_existing.stdout | string
            - cisc_rt_000130_int_acl_line_8 not in cisc_rt_000130_acl_showrun_internal_existing.stdout_lines | string
          with_items:
            - "{{ iosrtr_internal_acl_addresses }}"

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Create Control Warning For End Of Play iosrtr_internal_acl_addresses Line 8."
          set_fact:
            control_number:
              - "{{ control_number }} + [ CISC-RT-000130 - {{ iosrtr_internal_existing_acl }} deny   ip any any log-input Not Present ]"
            warn_count: "{{ warn_count|int + 1 }}"
          when:
            - "'none' not in iosrtr_internal_existing_acl"
            - iosrtr_internal_existing_acl in cisc_rt_000130_acl_showrun_internal_existing.stdout | string
            - cisc_rt_000130_int_acl_line_8 not in cisc_rt_000130_acl_showrun_internal_existing.stdout_lines | string
          with_items:
            - "{{ iosrtr_internal_acl_addresses }}"

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Add ACL To Interfaces Listed In iosrtr_external_acl_interfaces."
          ios_config:
            parents:
              - "interface {{ item.0 }}"
            lines:
              - "ip access-group {{ iosrtr_external_existing_acl }} in"
          with_together: 
            - "{{ cisc_rt_000130_intname }}"
            - "{{ cisc_rt_000130_intstdout }}"
          when:
            - iosrtr_external_existing_acl in cisc_rt_000130_acl_showrun_external_existing.stdout | string
            - item.0 in iosrtr_external_acl_interfaces
            - iosrtr_external_existing_acl not in item.1

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Remove ACL From Interfaces Not Listed In iosrtr_external_acl_interfaces."
          ios_config:
            parents:
              - "interface {{ item.0 }}"
            lines:
              - "no ip access-group {{ iosrtr_external_existing_acl }} in"
          with_together: 
            - "{{ cisc_rt_000130_intname }}"
            - "{{ cisc_rt_000130_intstdout }}"
          when:
            - iosrtr_external_existing_acl in cisc_rt_000130_acl_showrun_external_existing.stdout | string
            - item.0 not in iosrtr_external_acl_interfaces
            - iosrtr_external_existing_acl in item.1

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Add ACL To Interfaces Listed In iosrtr_internal_acl_interfaces."
          ios_config:
            parents:
              - "interface {{ item.0 }}"
            lines:
              - "ip access-group {{ iosrtr_internal_existing_acl }} in"
          with_together: 
            - "{{ cisc_rt_000130_intname }}"
            - "{{ cisc_rt_000130_intstdout }}"
          when:
            - iosrtr_internal_existing_acl in cisc_rt_000130_acl_showrun_internal_existing.stdout | string
            - item.0 in iosrtr_internal_acl_interfaces
            - iosrtr_internal_existing_acl not in item.1

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Remove ACL From Interfaces Not Listed In iosrtr_internal_acl_interfaces."
          ios_config:
            parents:
              - "interface {{ item.0 }}"
            lines:
              - "no ip access-group {{ iosrtr_internal_existing_acl }} in"
          with_together: 
            - "{{ cisc_rt_000130_intname }}"
            - "{{ cisc_rt_000130_intstdout }}"
          when:
            - iosrtr_internal_existing_acl in cisc_rt_000130_acl_showrun_internal_existing.stdout | string
            - item.0 not in iosrtr_internal_acl_interfaces
            - iosrtr_internal_existing_acl in item.1
      when: 
        - not cisc_rt_hardening_one_device
        - "'none' not in iosrtr_external_existing_acl or 'none' not in iosrtr_internal_existing_acl"

    - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Single Router Setup."
      block:
        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Remove Old External Access List."
          ios_acls:
              config:
                  - afi: ipv4
                    acls:
                      - name: "{{ iosrtr_external_acl_name_old }}"
              state: deleted
          when: 
            - "'none' not in iosrtr_external_acl_name_old"

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Parse User Given ACL From host_vars For External ACL."
          ios_acls:
            running_config: "{{ lookup('file','files/cisc-rt-000130-ext-acl.txt') }}"
            state: parsed
          register: cisc_rt_000130_ext_acl_parsed

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Convert JSON to DICT For ACL Defined Name For External ACL."
          set_fact:
            cisc_rt_000130_ext_acl_name: "{{ cisc_rt_000130_ext_acl_parsed.parsed.0.acls.0.name }}"
        
        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Compare And Update ACL For External ACL."
          ios_acls:
            config: "{{ cisc_rt_000130_ext_acl_parsed.parsed }}"
            state: replaced
          register: cisc_rt_000130_ext_acl_ran

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Print Changed Lines With Debug When ACL Is Changed For External ACL."
          debug:
            var: cisc_rt_000130_ext_acl_ran.commands
          when: 
            - cisc_rt_000130_ext_acl_ran.changed

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Remove Old Internal Access List."
          ios_acls:
              config:
                  - afi: ipv4
                    acls:
                      - name: "{{ iosrtr_internal_acl_name_old }}"
              state: deleted
          when: 
            - "'none' not in iosrtr_internal_acl_name_old"

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Parse User Given ACL From host_vars For Internal ACL."
          ios_acls:
            running_config: "{{ lookup('file','files/cisc-rt-000130-int-acl.txt') }}"
            state: parsed
          register: cisc_rt_000130_int_acl_parsed

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Convert JSON to DICT For ACL Defined Name For Internal ACL."
          set_fact:
            cisc_rt_000130_int_acl_name: "{{ cisc_rt_000130_int_acl_parsed.parsed.0.acls.0.name }}"
        
        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Compare And Update ACL For External ACL."
          ios_acls:
            config: "{{ cisc_rt_000130_int_acl_parsed.parsed }}"
            state: replaced
          register: cisc_rt_000130_int_acl_ran

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Print Changed Lines With Debug When ACL Is Changed For Internal ACL."
          debug:
            var: cisc_rt_000130_int_acl_ran.commands
          when: 
            - cisc_rt_000130_int_acl_ran.changed

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Gather Interface Facts."
          ios_interfaces:
            state: gathered
          register: cisc_rt_000130_interfaceinfo

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Register Show Run With Interfaces."
          ios_command:
            commands: 
              - "show run | section {{ item.name }}" 
          with_items: "{{ cisc_rt_000130_interfaceinfo.gathered }}"
          register: cisc_rt_000130_interfaceinfo_showrun

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Set Fact For Interface Name And Stdout." 
          set_fact:
            cisc_rt_000130_intname: "{{ cisc_rt_000130_interfaceinfo_showrun.results | map(attribute='item.name') }}"
            cisc_rt_000130_intstdout: "{{ cisc_rt_000130_interfaceinfo_showrun.results | map(attribute='stdout') }}"

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Add ACL To Interfaces Listed In iosrtr_external_acl_interfaces."
          ios_config:
            parents:
              - "interface {{ item.0 }}"
            lines:
              - "ip access-group {{ cisc_rt_000130_ext_acl_name }} in"
          with_together: 
            - "{{ cisc_rt_000130_intname }}"
            - "{{ cisc_rt_000130_intstdout }}"
          when:
            - item.0 in iosrtr_external_acl_interfaces
            - cisc_rt_000130_ext_acl_name not in item.1

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Add ACL To Interfaces Listed In iosrtr_internal_acl_interfaces."
          ios_config:
            parents:
              - "interface {{ item.0 }}"
            lines:
              - "ip access-group {{ cisc_rt_000130_int_acl_name }} in"
          with_together: 
            - "{{ cisc_rt_000130_intname }}"
            - "{{ cisc_rt_000130_intstdout }}"
          when:
            - item.0 in iosrtr_internal_acl_interfaces
            - cisc_rt_000130_int_acl_name not in item.1

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Remove ACL From Interfaces Not Listed In iosrtr_external_acl_interfaces."
          ios_config:
            parents:
              - "interface {{ item.0 }}"
            lines:
              - "no ip access-group {{ cisc_rt_000130_ext_acl_name }} in"
          with_together: 
            - "{{ cisc_rt_000130_intname }}"
            - "{{ cisc_rt_000130_intstdout }}"
          when:
            - item.0 not in iosrtr_external_acl_interfaces
            - cisc_rt_000130_ext_acl_name in item.1

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Remove ACL From Interfaces Not Listed In iosrtr_internal_acl_interfaces."
          ios_config:
            parents:
              - "interface {{ item.0 }}"
            lines:
              - "no ip access-group {{ cisc_rt_000130_int_acl_name }} in"
          with_together: 
            - "{{ cisc_rt_000130_intname }}"
            - "{{ cisc_rt_000130_intstdout }}"
          when:
            - item.0 not in iosrtr_internal_acl_interfaces
            - cisc_rt_000130_int_acl_name in item.1

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Remove Old External ACL From All Interfaces On Router."
          ios_config:
            parents:
              - "interface {{ item.0 }}"
            lines:
              - "no ip access-group {{ iosrtr_external_acl_name_old }} in"
          with_together: 
            - "{{ cisc_rt_000130_intname }}"
            - "{{ cisc_rt_000130_intstdout }}"
          when:
            - "'none' not in iosrtr_external_acl_name_old"
            - item.0 is defined
            - iosrtr_external_acl_name_old in item.1

        - name: "HIGH | CISC-RT-000130 | PATCH | The Cisco router must be configured to restrict traffic destined to itself. | Remove Old Internal ACL From All Interfaces On Router."
          ios_config:
            parents:
              - "interface {{ item.0 }}"
            lines:
              - "no ip access-group {{ iosrtr_internal_acl_name_old }} in"
          with_together: 
            - "{{ cisc_rt_000130_intname }}"
            - "{{ cisc_rt_000130_intstdout }}"
          when:
            - "'none' not in iosrtr_internal_acl_name_old"
            - item.0 is defined
            - iosrtr_internal_acl_name_old in item.1
      when: 
        - cisc_rt_hardening_one_device
        - "'none' in iosrtr_external_existing_acl or iosrtr_internal_existing_acl"
  when:
      - cisc_rt_000130
  tags:
      - CISC-RT-000130
      - CAT1
      - CCI-001097
      - SRG-NET-000205-RTR-000001
      - SV-216561r531085_rule
      - V-216561













# - name: "HIGH | CISC-RT-000240 | PATCH | The Cisco perimeter router must be configured to deny network traffic by default and allow network traffic by exception."
#   block:
#     - name: "HIGH | CISC-RT-000240 | PATCH | The Cisco perimeter router must be configured to deny network traffic by default and allow network traffic by exception. | Search Inbound ACL To Verify That It Is Configured To Deny All Other Traffic That Is Not Explicity Allowed."
#       ios_command:
#         commands:
#           - "show run | section ip access-list extended {{ cisc_rt_000130_ext_acl_name }}"
#       register: cisc_rt_000240_iosrtr_deny_all_other_traffic_check

#     - name: "HIGH | CISC-RT-000240 | PATCH | The Cisco perimeter router must be configured to deny network traffic by default and allow network traffic by exception. | Set Fact For Deny Ip Search."
#       set_fact:
#         cisc_rt_000240_acl_check: "{{ cisc_rt_000240_iosrtr_deny_all_other_traffic_check.stdout | regex_search('deny   ip any any log-input') }}"

#     - name: "HIGH | CISC-RT-000240 | PATCH | The Cisco perimeter router must be configured to deny network traffic by default and allow network traffic by exception. | Acl Addition Warning When cisc_rt_000240_acl_check Is Not Defined."
#       debug:
#         msg: "Warning!!! {{ cisc_rt_000130_ext_acl_name }} Does Not Have Deny All Other Traffic That Is Not Explicity Allowed In The ACL. We Are Adding It To The {{ cisc_rt_000130_ext_acl_name }} At Sequence Number 300.  Please Go Back To host_vars/cisc-rt-000130-ext-acl And Add It To The End Of The ACL."
#       when: 
#         - cisc_rt_000240_acl_check != "deny   ip any any log-input"

#     - name: "HIGH | CISC-RT-000240 | PATCH | The Cisco perimeter router must be configured to deny network traffic by default and allow network traffic by exception. | Warning Msg At End Of Playbook."
#       set_fact:
#         control_number:
#           - "{{ control_number }} + [ CISC-RT-000240 - Acl Addition Warning ]"
#         warn_count: "{{ warn_count|int + 1 }}"
#       when: 
#         - cisc_rt_000240_acl_check != "deny   ip any any log-input"

#     - name: "HIGH | CISC-RT-000240 | PATCH | The Cisco perimeter router must be configured to deny network traffic by default and allow network traffic by exception. | Correct The ACL By Adding Proper Configuration To Deny All Other Traffic That Is Not Explicity Allowed."
#       ios_config:
#         parents:
#           - "ip access-list extended {{ cisc_rt_000130_ext_acl_name }}"
#         commands:
#           - "300 deny ip any any log-input"
#       when: cisc_rt_000240_acl_check != "deny   ip any any log-input"
#   when:
#       - cisc_rt_000240
#       - not cisc_rt_dodin_backbone
#   tags:
#       - CISC-RT-000240
#       - CAT1
#       - CCI-001109
#       - SRG-NET-000202-RTR-000001
#       - SV-216572r531085_rule
#       - V-216572

















- name: "HIGH | CISC-RT-000280 | PATCH | The Cisco perimeter router must be configured to protect an enclave connected to an alternate gateway by using an inbound filter that only permits packets with destination addresses within the sites address space."
  block:
    - name: "HIGH | CISC-RT-000280 | PATCH | The Cisco perimeter router must be configured to protect an enclave connected to an alternate gateway by using an inbound filter that only permits packets with destination addresses within the sites address space. | Rmmove Old FILTER_ISP Access Control Lost."
      ios_acls:
        config:
          - afi: ipv4
            acls:
              - name: "{{ iosrtr_filter_isp_name_old }}"
        state: deleted
      when: 
        - "'none' not in iosrtr_filter_isp_name_old"

    - name: "HIGH | CISC-RT-000280 | PATCH | The Cisco perimeter router must be configured to protect an enclave connected to an alternate gateway by using an inbound filter that only permits packets with destination addresses within the sites address space. | Parse User Given ACL From host_vars."
      ios_acls:
        running_config: "{{ lookup('file','files/cisc-rt-000280-acl.txt') }}"
        state: parsed
      register: cisc_rt_000280_acl_parsed

    - name: "HIGH | CISC-RT-000280 | PATCH | The Cisco perimeter router must be configured to protect an enclave connected to an alternate gateway by using an inbound filter that only permits packets with destination addresses within the sites address space. | Convert JSON to DICT For ACL Defined Name."
      set_fact:
        cisc_rt_000280_acl_name: "{{ cisc_rt_000280_acl_parsed.parsed.0.acls.0.name }}"
    
    - name: "HIGH | CISC-RT-000280 | PATCH | The Cisco perimeter router must be configured to protect an enclave connected to an alternate gateway by using an inbound filter that only permits packets with destination addresses within the sites address space. | Compare And Update ACL."
      ios_acls:
        config: "{{ cisc_rt_000280_acl_parsed.parsed }}"
        state: replaced
      register: cisc_rt_000280_acl_ran

    - name: "HIGH | CISC-RT-000280 | PATCH | The Cisco perimeter router must be configured to protect an enclave connected to an alternate gateway by using an inbound filter that only permits packets with destination addresses within the sites address space. | Print Changed Lines With Debug When ACL Is Changed."
      debug:
        var: cisc_rt_000280_acl_ran.commands
      when: 
        - cisc_rt_000280_acl_ran.changed

    - name: "HIGH | CISC-RT-000280 | PATCH | The Cisco perimeter router must be configured to protect an enclave connected to an alternate gateway by using an inbound filter that only permits packets with destination addresses within the sites address space. | Gather Interface Facts."
      ios_interfaces:
        state: gathered
      register: cisc_rt_000280_interfaceinfo

    - name: "HIGH | CISC-RT-000280 | PATCH | The Cisco perimeter router must be configured to protect an enclave connected to an alternate gateway by using an inbound filter that only permits packets with destination addresses within the sites address space. | Register Show Run With Interfaces."
      ios_command:
        commands: 
          - "show run | section {{ item.name }}" 
      with_items: "{{ cisc_rt_000280_interfaceinfo.gathered }}"
      register: cisc_rt_000280_interfaceinfo_showrun

    - name: "HIGH | CISC-RT-000280 | PATCH | The Cisco perimeter router must be configured to protect an enclave connected to an alternate gateway by using an inbound filter that only permits packets with destination addresses within the sites address space. | Set Fact For Interface Name And Stdout." 
      set_fact:
        cisc_rt_000280_intname: "{{ cisc_rt_000280_interfaceinfo_showrun.results | map(attribute='item.name') }}"
        cisc_rt_000280_intstdout: "{{ cisc_rt_000280_interfaceinfo_showrun.results | map(attribute='stdout') }}"

    - name: "HIGH | CISC-RT-000280 | PATCH | The Cisco perimeter router must be configured to protect an enclave connected to an alternate gateway by using an inbound filter that only permits packets with destination addresses within the sites address space. | Add ACL To Interfaces Listed In iosrtr_filter_isp_acl_interfaces."
      ios_config:
        parents:
          - "interface {{ item.0 }}"
        lines:
          - "ip access-group {{ cisc_rt_000280_acl_name }} in"
      with_together: 
        - "{{ cisc_rt_000280_intname }}"
        - "{{ cisc_rt_000280_intstdout }}"
      when:
        - item.0 in iosrtr_filter_isp_acl_interfaces
        - cisc_rt_000280_acl_name not in item.1

    - name: "HIGH | CISC-RT-000280 | PATCH | The Cisco perimeter router must be configured to protect an enclave connected to an alternate gateway by using an inbound filter that only permits packets with destination addresses within the sites address space. | Remove ACL From Interfaces Not Listed In iosrtr_filter_isp_acl_interfaces."
      ios_config:
        parents:
          - "interface {{ item.0 }}"
        lines:
          - "no ip access-group {{ cisc_rt_000280_acl_name }} in"
      with_together: 
        - "{{ cisc_rt_000280_intname }}"
        - "{{ cisc_rt_000280_intstdout }}"
      when:
        - item.0 not in iosrtr_filter_isp_acl_interfaces
        - cisc_rt_000280_acl_name in item.1

    - name: "HIGH | CISC-RT-000280 | PATCH | The Cisco perimeter router must be configured to protect an enclave connected to an alternate gateway by using an inbound filter that only permits packets with destination addresses within the sites address space. | Set Fact For Interfaces With Description."
      set_fact:
        cisc_rt_000280_interface_with_descriptions: "{{ item.name, item.description }}"
      with_items: "{{ cisc_rt_000280_interfaceinfo.gathered }}"

    - name: "HIGH | CISC-RT-000280 | PATCH | The Cisco perimeter router must be configured to protect an enclave connected to an alternate gateway by using an inbound filter that only permits packets with destination addresses within the sites address space. | Fix Descriptions For iosrtr_filter_isp_acl_interfaces."
      ios_config:
        parents:
          - "interface {{ item }}"
        lines:
          - "description {{ iosrtr_filter_isp_interface_description }}"
      with_items: 
        - "{{ iosrtr_filter_isp_acl_interfaces }}"
      when:
        - cisc_rt_000280_interface_with_descriptions != iosrtr_filter_isp_interface_description     

    - name: "HIGH | CISC-RT-000280 | PATCH | The Cisco perimeter router must be configured to protect an enclave connected to an alternate gateway by using an inbound filter that only permits packets with destination addresses within the sites address space. | Remove Description From Interface Not In iosrtr_filter_isp_acl_interfaces."
      ios_config:
        parents:
          - "interface {{ item.name }}"
        lines:
          - "no description"
      when: 
        - item.name not in iosrtr_filter_isp_acl_interfaces
        - item.description is defined
        - item.description == iosrtr_filter_isp_interface_description
      with_items: 
        - "{{ cisc_rt_000280_interfaceinfo.gathered }}"

    - name: "HIGH | CISC-RT-000280 | PATCH | The Cisco perimeter router must be configured to protect an enclave connected to an alternate gateway by using an inbound filter that only permits packets with destination addresses within the sites address space. | Remove Old ACL From All Interfaces On Router."
      ios_config:
        parents:
          - "interface {{ item.0 }}"
        lines:
          - "no ip access-group {{ iosrtr_filter_isp_name_old }} in"
      with_together: 
        - "{{ cisc_rt_000280_intname }}"
        - "{{ cisc_rt_000280_intstdout }}"
      when:
        - "'none' not in iosrtr_filter_isp_name_old"
        - item.0 is defined
        - iosrtr_filter_isp_name_old in item.1
  when:
      - cisc_rt_000280
      - not cisc_rt_dodin_backbone
  tags:
      - CISC-RT-000280
      - CAT1
      - CCI-001414
      - SRG-NET-000019-RTR-000008
      - SV-216576r531085_rule
      - V-216576

- name: "HIGH | CISC-RT-000290 | PATCH | The Cisco perimeter router must be configured to not be a Border Gateway Protocol (BGP) peer to an alternate gateway service provider."
  block:
    - name: Verify that the router is not BGP peering with this router.
      ios_command:
          commands:
            - "show run | section include bgp"
      register: iosrtr_bgp_peering_with_alterrnate_gateway_service_provider

    - name: "HIGH | CISC-RT-000290 | PATCH | The Cisco perimeter router must be configured to not be a Border Gateway Protocol (BGP) peer to an alternate gateway service provider. | Set Fact For Neighbor Ip Addresses."
      set_fact:
          cisc_rt_000290_list: "{{ iosrtr_bgp_peering_with_alterrnate_gateway_service_provider.stdout_lines | regex_findall('((?:[0-9]{1,3}.){3}[0-9]{1,3})') }}"

    - name: "HIGH | CISC-RT-000290 | PATCH | The Cisco perimeter router must be configured to not be a Border Gateway Protocol (BGP) peer to an alternate gateway service provider. | Add Static Route If It Is BGP Peering With Provider."
      ios_static_routes:
          config:
          - address_families:
            - afi: ipv4
              routes:
                - dest: 0.0.0.0/0
                  next_hops:
                    - forward_router_address: "{{ item }}"
      with_items:
        - "{{ iosrtr_isp_router_ip_address }}"
      when: item in cisc_rt_000290_list
      
    - name: "HIGH | CISC-RT-000290 | PATCH | The Cisco perimeter router must be configured to not be a Border Gateway Protocol (BGP) peer to an alternate gateway service provider. | Remove any BGP Peering neighbors from configuration."
      ios_config:
          parents:
            - "router bgp {{ iosrtr_local_bgp_autonomous_system_number }}"
          lines:
            - "no neighbor {{ item }}"
      with_items:
        - "{{ iosrtr_isp_router_ip_address }}"
      when: item in cisc_rt_000290_list
  when:
      - cisc_rt_000290
      - not cisc_rt_dodin_backbone
  tags:
      - CISC-RT-000290
      - CAT1
      - CCI-001414
      - SRG-NET-000019-RTR-000009
      - SV-216577r531085_rule
      - V-216577











- name: | 
        "HIGH | CISC-RT-000630 | PATCH | The Cisco PE router must be configured to have each Virtual Routing and Forwarding (VRF) instance bound to the appropriate physical or logical interfaces to maintain traffic separation between all MPLS L3VPNs."
        "HIGH | CISC-RT-000640 | PATCH | The Cisco PE router must be configured to have each Virtual Routing and Forwarding (VRF) instance with the appropriate Route Target (RT)."
  block:
    - name: "Create VRF Entries"
      ios_vrf_lite:
        name: 'test' 
        # rd: '400:1'
        # route_import: '400:1'
        # route_export: '400:1'
        description: 'Why Arent You Working'
        state: present
      # with_items:
      #   - "{{ iosrtr_ce_facing_vrf_interfaces }}"
  
    
    
    
    
    
    
    
    
    - name: Gather Interface Facts."
      ios_interfaces:
        state: gathered
      register: cisc_rt_000630_interfaceinfo

    - name: Register Show Run With Interfaces."
      ios_command:
        commands: 
          - "show run | section {{ item.name }}" 
      with_items: "{{ cisc_rt_000630_interfaceinfo.gathered }}"
      register: cisc_rt_000630_interfaceinfo_showrun

    - name: Set Fact For Interface Name And Stdout." 
      set_fact:
        cisc_rt_000630_intname: "{{ cisc_rt_000630_interfaceinfo_showrun.results | map(attribute='item.name') }}"
        cisc_rt_000630_intstdout: "{{ cisc_rt_000630_interfaceinfo_showrun.results | map(attribute='stdout') }}"









    
    # - name: Apply VRF To Interfaces
    #   ios_config:
    #     parents: 
    #       - "interface {{ item.1 }}"
    #     lines: 
    #       - "ip vrf forwarding {{ 0.item.vrf_route_name }}"
    #   with_items: 
    #     - "{{ iosrtr_ce_facing_vrf_interfaces }}"
    #     - "{{ cisc_rt_000630_intname }}"
    #     - "{{ cisc_rt_000630_intstdout }}"
    #   when:
    #     - 
    #     - cisc_rt_000280_acl_name in item.1






    # - name: "Check For Active VRF's For Stig"
    #   ios_command:
    #     commands: 
    #       - show run | include ip vrf
    #   register: cisc_rt_000630_ip_vrf_active

    # - name: set fact
    #   set_fact:
    #     list_prune: "{{ cisc_rt_000630_ip_vrf_active.stdout_lines | regex_replace('ip vrf forwarding ', '') | regex_replace('ip vrf ', '')  }}"

    # - name: Print Fact
    #   debug:
    #     msg: "{{ list_prune }}"
    
    # - name: "Clear Exiting VRF From iosrtr_ce_facing_vrf_interfaces"
    #   ios_vrf_lite:
    #     name: "{{ list_prune }}"
    #     state: absent
    #   when: list_prune not in item.vrf_route_name
    #   with_items:
    #     - "{{ iosrtr_ce_facing_vrf_interfaces }}"










    

    
    # - name: "Clear Exiting VRF From iosrtr_ce_facing_vrf_interfaces"
    #   ios_vrf_lite:
    #     name: "{{ item }}"
    #     state: absent
    #   with_items:
    #     - "{{ list_prune }}"
    #     - "{{ iosrtr_ce_facing_vrf_interfaces }}"
    #   when: list_prune not in item.vrf_route_name

    # - name: Wait For delete
    #   wait_for_connection:
    #     delay: 10


    # - name: Check To See if description matches
    #   ios_command:
    #     commands: 
    #       - show run | include description
    #   register: cisc_rt_000630_vrf_description_check

    # - name: Add Description
    #   ios_config:
    #     parents: ip vrf {{ item.vrf_route_name }}
    #     commands: description {{ item.vrf_description }}
    #   when: item.vrf_description not in cisc_rt_000630_vrf_description_check
    #   with_items:
    #     - "{{ iosrtr_ce_facing_vrf_interfaces }}"


    
    # - name: Apply IP Address Back On Interface
    #   ios_config:
    #     parents: interface {{ item.interface }}
    #     lines: 
    #       - ip address {{ item.ip_address }} {{ item.ip_subnet }}
    #   with_items: 
    #     - "{{ iosrtr_ce_facing_vrf_interfaces }}"
  when:
      - cisc_rt_000630 or cisc_rt_000640
  tags:
      - CISC-RT-000630
      - CISC-RT-000640
      - CAT1
      - CCI-000366
      - SRG-NET-000512-RTR-000005
      - SRG-NET-000512-RTR-000006
      - SV-216611r531085_rule
      - SV-216612r531085_rule
      - V-216611
      - V-216612

- name: "HIGH | CISC-RT-000670 | PATCH | The Cisco PE router providing MPLS Virtual Private Wire Service (VPWS) must be configured to have the appropriate virtual circuit identification (VC ID) for each attachment circuit."
  block:
    - name:
      block:
        - name:  Gather Interface Facts."
          ios_interfaces:
            state: gathered
          register: cisc_rt_000670_interfaceinfo

        - name: Register Show Run With Interfaces."
          ios_command:
            commands: 
              - "show run | section {{ item.name }}" 
          with_items: "{{ cisc_rt_000670_interfaceinfo.gathered }}"
          register: cisc_rt_000670_interfaceinfo_showrun_exisiting

        - name: VC ID has not been configured Error Message." 
          debug:
            msg: 
              - "Warning!!! Review The Cisco PE router providing MPLS Virtual Private Wire Service (VPWS) must be configured to have the appropriate virtual circuit identification (VC ID) for each attachment circuit."
              - "The defined User Defined {{ item.address }} {{ item.vcid }} Not Present On {{ item.interface }} and must be configured."
          when:
            - item not in cisc_rt_000670_interfaceinfo_showrun_exisiting.stdout | string
          with_items:
            - "{{ ios_rtr_vcid_ce_facing.vcid }}"

        # - name: Create Control Warning For End Of Play."
        #   set_fact:
        #     control_number:
        #       - "{{ control_number }} + [ CISC-RT-000670 - User Defined {{ item.address }} {{ item.vcid }} Not Present On {{ item.interface }} ]"
        #     warn_count: "{{ warn_count|int + 1 }}"
        #   when:
        #     - item not in cisc_rt_000670_interfaceinfo_showrun_exisiting.stdout | string
        #   with_items:
        #     - "{{ ios_rtr_vcid_ce_facing.[0].vcid }}"


        # - name: Apply to Interfaces
        #   ios_config:
        #     parents:
        #       - interface {{ item.interface }}
        #     lines:
        #       - encapsulation dot1Q {{ item.vcid }}
        #       - xconnect {{ item.ip_address }} {{ item.vcid }} encapsulation mpls
        #   with_items:
        #     - "{{ ios_rtr_vcid_ce_facing }}"
  when:
      - cisc_rt_000670
  tags:
      - CISC-RT-000670
      - CAT1
      - CCI-000366
      - SRG-NET-000512-RTR-000008
      - SV-216615r531085_rule
      - V-216615




















- name: "HIGH | CISC-RT-000730 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure."
  block:
    - name: "HIGH | CISC-RT-000730 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | No ACL Defined Check Block."
      block:
        - name: "HIGH | CISC-RT-000730 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | No ACL Defined Warning Message."
          debug:
            msg: 
              - "Warning!!! Review the router configuration to verify that an ingress ACL is applied to all external or CE-facing interfaces."
              - "If the PE router is not configured to block any traffic with a destination address assigned to the IP core infrastructure, this is a finding. To Fix this error please define a existing ACL in iosrtr_block_to_core_existing_acl in defaults main."

        - name: "HIGH | CISC-RT-000730 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Create Control Warning For End Of Play."
          set_fact:
            control_number:
              - "{{ control_number }} + [ CISC-RT-000730 - You Have Not Entered A ACL Name ]"
            warn_count: "{{ warn_count|int + 1 }}"
      when:
        - "'none' in iosrtr_block_to_core_existing_acl"
        - not cisc_rt_hardening_one_device
        
    - name: "HIGH | CISC-RT-000730 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | User Defined (Existing ACL) In Defaults Main Or Template."
      block: 
        - name: "HIGH | CISC-RT-000730 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Show Run Existing ACL."
          ios_command:
            commands:
              - "show run | section {{ iosrtr_block_to_core_existing_acl }}"
          register: cisc_rt_000730_acl_showrun_existing

        - name: "HIGH | CISC-RT-000730 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | No ACL Defined By That Name Warning." 
          debug:
            msg: 
              - "Warning!!! Review the router configuration to verify that an ingress ACL is applied to all external or CE-facing interfaces."
              - "The defined ACL {{ item }} is not present on the Router and must be configured."
          when:
            - item not in cisc_rt_000730_acl_showrun_existing.stdout | string
          with_items:
            - "{{ iosrtr_block_to_core_existing_acl }}"

        - name: "HIGH | CISC-RT-000730 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Create Control Warning For End Of Play."
          set_fact:
            control_number:
              - "{{ control_number }} + [ CISC-RT-000730 - User Defined (Existing ACL) {{ item }} Not Present ]"
            warn_count: "{{ warn_count|int + 1 }}"
          when:
            - item not in cisc_rt_000730_acl_showrun_existing.stdout | string
          with_items:
            - "{{ iosrtr_block_to_core_existing_acl }}"
        
        - name: "HIGH | CISC-RT-000730 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Gather Interface Facts."
          ios_interfaces:
            state: gathered
          register: cisc_rt_000730_interfaceinfo  
          when:
            - "iosrtr_block_to_core_existing_acl in cisc_rt_000730_acl_showrun_existing.stdout | string"

        - name: "HIGH | CISC-RT-000730 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Register Show Run With Interfaces."
          ios_command:
            commands: 
              - "show run | section {{ item.name }}" 
          with_items: "{{ cisc_rt_000730_interfaceinfo.gathered }}"
          register: cisc_rt_000730_interfaceinfo_showrun_exisiting
          when:
            - "iosrtr_block_to_core_existing_acl in cisc_rt_000730_acl_showrun_existing.stdout | string"

        - name: "HIGH | CISC-RT-000730 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Set Fact For Interface Name And Interface Stdout." 
          set_fact:
            cisc_rt_000730_intname_existing: "{{ cisc_rt_000730_interfaceinfo_showrun_exisiting.results | map(attribute='item.name') }}"
            cisc_rt_000730_intstdout_existing: "{{ cisc_rt_000730_interfaceinfo_showrun_exisiting.results | map(attribute='stdout') }}"
            cisc_rt_000730_acl_all_addresses: "{{ cisc_rt_000730_acl_showrun_existing.stdout_lines | regex_findall('\\S*\\d+ \\S*') | list }}"
            cisc_rt_000730_acl_permit_addresses: "{{ cisc_rt_000730_acl_showrun_existing.stdout | regex_findall('permit ip any \\S*\\d+ \\S*') | regex_replace('permit ip any ') }}"
          when: 
            - "iosrtr_block_to_core_existing_acl in cisc_rt_000730_acl_showrun_existing.stdout | string"
 
        - name: "HIGH | CISC-RT-000730 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Add Entires From iosrtr_egress_acl_filter_address_space With Proper Settings."
          ios_config:
            parents:
              - "ip access-list extended {{ iosrtr_block_to_core_existing_acl }}"
            lines:
              - "deny ip any {{ item }} log-input"
          with_items:
            - "{{ iosrtr_block_to_core_existing_acl_ip_core_address_space }}"
          register: cisc_rt_000730_ip_added
          when:
            - "iosrtr_block_to_core_existing_acl in cisc_rt_000730_acl_showrun_existing.stdout | string"
            - "'none' not in iosrtr_block_to_core_existing_acl"
            - item not in cisc_rt_000730_acl_all_addresses

        - name: "HIGH | CISC-RT-000730 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Remove Entries That Are Not In iosrtr_egress_acl_filter_address_space."
          ios_config:
            parents: 
              - "ip access-list extended {{ iosrtr_block_to_core_existing_acl }}"
            lines:
              - "no deny ip any {{ item }} log-input"
          with_items:
            - "{{ cisc_rt_000730_acl_all_addresses }}"
          when:
            - "iosrtr_block_to_core_existing_acl in cisc_rt_000730_acl_showrun_existing.stdout | string"
            - item not in iosrtr_block_to_core_existing_acl_ip_core_address_space

        - name: "HIGH | CISC-RT-000730 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Remove Permit Ip Address Entries From ACL."
          ios_config:
            parents: 
              - "ip access-list extended {{ iosrtr_block_to_core_existing_acl }}"
            lines:
              - "no permit ip any {{ item }} log-input"
          when:
            - "iosrtr_block_to_core_existing_acl in cisc_rt_000730_acl_showrun_existing.stdout | string"
            - item in cisc_rt_000730_acl_all_addresses
          with_items:
            - "{{ cisc_rt_000730_acl_permit_addresses }}"

        - name: "HIGH | CISC-RT-000730 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Remove Permit IP Any Any."
          ios_config: 
            parents: 
              - "ip access-list extended {{ iosrtr_block_to_core_existing_acl }}"
            lines:
              - "no permit ip any any"
          when:
            - "iosrtr_block_to_core_existing_acl in cisc_rt_000730_acl_showrun_existing.stdout | string"
            - cisc_rt_000730_ip_added.changed

        - name: "HIGH | CISC-RT-000730 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Add Permit Entry At End Of ACL." 
          ios_acls:
            config:
                - afi: ipv4
                  acls:
                  - name: '{{ iosrtr_block_to_core_existing_acl }}'
                    acl_type: extended
                    aces:
                    - grant: permit
                      sequence: 400
                      protocol: ip
                      source:
                        any: true
                      destination:
                        any: true
            state: merged
          when:
            - "iosrtr_block_to_core_existing_acl in cisc_rt_000730_acl_showrun_existing.stdout | string"
            - cisc_rt_000730_ip_added.changed

        - name: "HIGH | CISC-RT-000730 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Show Run Existing ACL."
          ios_command:
            commands:
              - "show run | section {{ iosrtr_block_to_core_existing_acl }}"
          register: cisc_rt_000730_acl_showrun_existing

        - name: "HIGH | CISC-RT-000730 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Set Facts For cisc_rt_000730_acl_all_addresses_final_check."
          set_fact: 
            cisc_rt_000730_acl_all_addresses_final_check: "{{ cisc_rt_000730_acl_showrun_existing.stdout_lines | regex_findall('\\S*\\d+ \\S*') | unique | list }}"
          when:
            - "iosrtr_block_to_core_existing_acl in cisc_rt_000730_acl_showrun_existing.stdout | string"

        - name: "HIGH | CISC-RT-000730 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Warning Display For ACL Inaccuracy."
          debug:
            msg: 
              - "Warning!!! The defined Address {{ item }} in {{ iosrtr_block_to_core_existing_acl_ip_core_address_space }} must be"
              - "removed by hand in order to make your router compliant to STIG standards. The current line entered"
              - "will continue to show as a error until removed from the ACL."
          with_items:
            - "{{ cisc_rt_000730_acl_all_addresses_final_check }}"
          when:
            - "iosrtr_block_to_core_existing_acl in cisc_rt_000730_acl_showrun_existing.stdout | string"
            - item not in iosrtr_block_to_core_existing_acl_ip_core_address_space

        - name: "HIGH | CISC-RT-000730 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Create Control Warning For End Of Play."
          set_fact:
            control_number:
              - "{{ control_number }} + [ CISC-RT-000730 - Address {{ item }} Must Be Removed By Hand From ACL ]"
            warn_count: "{{ warn_count|int + 1 }}"
          with_items:
            - "{{ cisc_rt_000730_acl_all_addresses_final_check }}"
          when:
            - "iosrtr_block_to_core_existing_acl in cisc_rt_000730_acl_showrun_existing.stdout | string"
            - item not in iosrtr_block_to_core_existing_acl_ip_core_address_space

        - name: "HIGH | CISC-RT-000730 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Attach ACL To CE Or External Interfaces."
          ios_config:
            parents:
              - "interface {{ item.0 }}"
            lines:
              - "ip access-group {{ iosrtr_block_to_core_existing_acl }} in"
          with_together: 
            - "{{ cisc_rt_000730_intname_existing }}"
            - "{{ cisc_rt_000730_intstdout_existing }}"
          when:
            - "iosrtr_block_to_core_existing_acl in cisc_rt_000730_acl_showrun_existing.stdout | string"
            - item.0 in iosrtr_external_facing_interfaces
            - iosrtr_block_to_core_existing_acl not in item.1

        - name: "HIGH | CISC-RT-000730 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Remove ACL from Interface Not In List."
          ios_config:
            parents:
              - "interface {{ item.0 }}"
            lines:
              - "no ip access-group {{ iosrtr_block_to_core_existing_acl }} in"
          with_together: 
            - "{{ cisc_rt_000730_intname_existing }}"
            - "{{ cisc_rt_000730_intstdout_existing }}"
          when:
            - "iosrtr_block_to_core_existing_acl in cisc_rt_000730_acl_showrun_existing.stdout | string"
            - item.0 not in iosrtr_external_facing_interfaces
            - iosrtr_block_to_core_existing_acl in item.1
      when: 
        - not cisc_rt_hardening_one_device
        - "'none' not in iosrtr_block_to_core_existing_acl"

    - name: "HIGH | CISC-RT-000730 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Single Router Setup Block."
      block: 
        - name: "HIGH | CISC-RT-000730 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Remove Old ACL." 
          ios_acls:
            config:
              - afi: ipv4
                acls:
                  - name: "{{ iosrtr_block_to_core_acl_name_old }}"
            state: deleted
          when: 
            - "'none' not in iosrtr_block_to_core_acl_name_old"

        - name: "HIGH | CISC-RT-000730 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Parse Given ACL From host_vars."
          ios_acls:
            running_config: "{{ lookup('file','files/cisc-rt-000730-acl.txt') }}"
            state: parsed
          register: cisc_rt_000730_acl_parsed

        - name: "HIGH | CISC-RT-000730 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Convert JSON to DICT For ACL Name."
          set_fact:
            cisc_rt_000730_acl_name: "{{ cisc_rt_000730_acl_parsed.parsed.0.acls.0.name }}"
        
        - name: "HIGH | CISC-RT-000730 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Compare And Reconsile ACL."
          ios_acls:
            config: "{{ cisc_rt_000730_acl_parsed.parsed }}"
            state: replaced
          register: cisc_rt_000730_acl_ran

        - name: "HIGH | CISC-RT-000730 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Print Changed Lines With Debug Acl Is Changed."
          debug:
            var: cisc_rt_000730_acl_ran.commands
          when: cisc_rt_000730_acl_ran.changed

        - name: "HIGH | CISC-RT-000730 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Gather Interface Facts."
          ios_interfaces:
            state: gathered
          register: cisc_rt_000730_interfaceinfo

        - name: "HIGH | CISC-RT-000730 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Register Show Run With Interfaces."
          ios_command:
            commands: 
              - "show run | section {{ item.name }}" 
          with_items: "{{ cisc_rt_000730_interfaceinfo.gathered }}"
          register: cisc_rt_000730_interfaceinfo_showrun

        - name: "HIGH | CISC-RT-000730 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Set Fact For Interface Name And Stdout." 
          set_fact:
            cisc_rt_000730_intname: "{{ cisc_rt_000730_interfaceinfo_showrun.results | map(attribute='item.name') }}"
            cisc_rt_000730_intstdout: "{{ cisc_rt_000730_interfaceinfo_showrun.results | map(attribute='stdout') }}"

        - name: "HIGH | CISC-RT-000730 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Remove ACL from Interface Not In List."
          ios_config:
            parents:
              - "interface {{ item.0 }}"
            lines:
              - "no ip access-group {{ cisc_rt_000730_acl_name }} in"
          with_together: 
            - "{{ cisc_rt_000730_intname }}"
            - "{{ cisc_rt_000730_intstdout }}"
          when:
            - item.0 not in iosrtr_external_facing_interfaces
            - cisc_rt_000730_acl_name in item.1

        - name: "HIGH | CISC-RT-000730 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Attach ACL To CE Or External Interfaces."
          ios_config:
            parents:
              - "interface {{ item.0 }}"
            lines:
              - "ip access-group {{ cisc_rt_000730_acl_name }} in"
          with_together: 
            - "{{ cisc_rt_000730_intname }}"
            - "{{ cisc_rt_000730_intstdout }}"
          when:
            - item.0 in iosrtr_external_facing_interfaces
            - cisc_rt_000730_acl_name not in item.1
      when: 
        - cisc_rt_hardening_one_device
        - "'none' in iosrtr_block_to_core_existing_acl"
  when:
      - cisc_rt_000730
  tags:
      - CISC-RT-000730
      - CAT1
      - CCI-001097
      - SRG-NET-000205-RTR-000007
      - SV-216616r531085_rule
      - V-216616

- name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure."
  block:
    - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | No ACL Defined Check Block."
      block:
        - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | No ACL Defined Warning Message."
          debug:
            msg: 
              - "Warning!!! Review the router configuration to verify egress ACL has been configured on all internal interfaces to restrict the router from accepting outbound IP packets that contain an illegitimate address in the source address field."
              - "If the egress ACL to restrict the router from accepting outbound IP packets that contain an illegitimate address in the source address field has not been configured on all internal interfaces in an enclave, this is a finding."
              - "To Fix this error please define a existing ACL in iosrtr_egress_filter_existing_acl in defaults main."

        - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Create Control Warning For End Of Play."
          set_fact:
            control_number:
              - "{{ control_number }} + [ CISC-RT-000310 - You Have Not Entered A ACL Name ]"
            warn_count: "{{ warn_count|int + 1 }}"
      when:
        - "'none' in iosrtr_egress_filter_existing_acl"
        - not cisc_rt_hardening_one_device

    - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | User Defined (Existing ACL) In Defaults Main Or Template."
      block:
        - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | User Defined (Existing ACL) In Defaults Main Or Template."
          block: 
            - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Show Run Existing ACL."
              ios_command:
                commands:
                  - "show run | section {{ iosrtr_egress_filter_existing_acl }}"
              register: cisc_rt_000310_acl_showrun_existing

            - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | No ACL Defined By That Name Warning." 
              debug:
                msg: 
                  - "Warning!!! Review the router configuration to verify egress ACL has been configured on all internal interfaces to restrict the router from accepting outbound IP packets that contain an illegitimate address in the source address field."
                  - "The defined ACL {{ item }} is not present on the Router and must be configured."
              when:
                - item not in cisc_rt_000310_acl_showrun_existing.stdout | string
              with_items:
                - "{{ iosrtr_egress_filter_existing_acl }}"

            - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Create Control Warning For End Of Play."
              set_fact:
                control_number:
                  - "{{ control_number }} + [ CISC-RT-000310 - User Defined (Existing ACL) {{ item }} Not Present ]"
                warn_count: "{{ warn_count|int + 1 }}"
              when:
                - item not in cisc_rt_000310_acl_showrun_existing.stdout | string
              with_items:
                - "{{ iosrtr_egress_filter_existing_acl }}"

            - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Gather Interface Facts."
              ios_interfaces:
                state: gathered
              register: cisc_rt_000310_interfaceinfo
              when:
                - iosrtr_egress_acl_filter or iosrtr_unicast_reverse_path_forwarding

            - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Register Show Run With Interfaces."
              ios_command:
                commands: 
                  - "show run | section {{ item.name }}" 
              with_items: "{{ cisc_rt_000310_interfaceinfo.gathered }}"
              register: cisc_rt_000310_interfaceinfo_showrun
              when:
                - iosrtr_egress_acl_filter or iosrtr_unicast_reverse_path_forwarding

            - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Set Fact For Interface Name And Stdout." 
              set_fact:
                cisc_rt_000310_intname: "{{ cisc_rt_000310_interfaceinfo_showrun.results | map(attribute='item.name') }}"
                cisc_rt_000310_intstdout: "{{ cisc_rt_000310_interfaceinfo_showrun.results | map(attribute='stdout') }}"
              when:
                - iosrtr_egress_acl_filter or iosrtr_unicast_reverse_path_forwarding

            - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Set Facts For Ip And Wildcard."
              set_fact: 
                cisc_rt_000310_acl_all_addresses: "{{ cisc_rt_000310_acl_showrun_existing.stdout_lines | regex_findall('\\S*\\d+ \\S*') | unique | list }}"
              when:
                - "iosrtr_egress_filter_existing_acl in cisc_rt_000310_acl_showrun_existing.stdout | string"

            - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Add Entires From iosrtr_egress_acl_filter_address_space With Proper Settings."
              ios_config:
                parents:
                  - "ip access-list extended {{ iosrtr_egress_filter_existing_acl }}"
                lines:
                  - "permit udp {{ item }} any eq domain"
                  - "permit tcp {{ item }} any eq ftp"
                  - "permit tcp {{ item }} any eq ftp-data"
                  - "permit tcp {{ item }} any eq www"
                  - "permit icmp {{ item }} any"
                  - "permit icmp {{ item }} any echo"
              with_items:
                - "{{ iosrtr_egress_acl_filter_address_space }}"
              when:
                - "iosrtr_egress_filter_existing_acl in cisc_rt_000310_acl_showrun_existing.stdout | string"
                - iosrtr_egress_acl_filter
                - "'none' not in iosrtr_egress_acl_filter_address_space"
                - item not in cisc_rt_000310_acl_all_addresses
            
            - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Remove Entries Found In cisc_rt_000310_acl_all_addresses That Are Not In iosrtr_egress_acl_filter_address_space."
              ios_config:
                parents:
                  - "ip access-list extended {{ iosrtr_egress_filter_existing_acl }}"
                lines:
                  - "no permit udp {{ item }} any eq domain"
                  - "no permit tcp {{ item }} any eq ftp"
                  - "no permit tcp {{ item }} any eq ftp-data"
                  - "no permit tcp {{ item }} any eq www"
                  - "no permit icmp {{ item }} any"
                  - "no permit icmp {{ item }} any echo"
              with_items:
                - "{{ cisc_rt_000310_acl_all_addresses }}"
              when:
                - "iosrtr_egress_filter_existing_acl in cisc_rt_000310_acl_showrun_existing.stdout | string"
                - iosrtr_egress_acl_filter
                - item not in iosrtr_egress_acl_filter_address_space

            - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Show Run Existing ACL."
              ios_command:
                commands:
                  - "show run | section {{ iosrtr_egress_filter_existing_acl }}"
              register: cisc_rt_000310_acl_showrun_existing

            - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Set Facts For Ip And Wildcard."
              set_fact: 
                cisc_rt_000310_acl_all_addresses_pruned: "{{ cisc_rt_000310_acl_showrun_existing.stdout_lines | regex_findall('\\S*\\d+ \\S*') | unique | list }}"
              when:
                - "iosrtr_egress_filter_existing_acl in cisc_rt_000310_acl_showrun_existing.stdout | string"

            - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Warning Display For ACL Inaccuracy."
              debug:
                msg: 
                  - "Warning!!! The defined Address {{ item }} in {{ iosrtr_egress_filter_existing_acl }} must be"
                  - "removed by hand in order to make your router compliant to STIG standards. The current line entered"
                  - "will continue to show as a error until removed from the ACL."
              with_items:
                - "{{ cisc_rt_000310_acl_all_addresses_pruned }}"
              when:
                - "iosrtr_egress_filter_existing_acl in cisc_rt_000310_acl_showrun_existing.stdout | string"
                - iosrtr_egress_acl_filter
                - item not in iosrtr_egress_acl_filter_address_space

            - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Create Control Warning For End Of Play."
              set_fact:
                control_number:
                  - "{{ control_number }} + [ CISC-RT-000310 - Address {{ item }} Must Be Removed By Hand From ACL ]"
                warn_count: "{{ warn_count|int + 1 }}"
              with_items:
                - "{{ cisc_rt_000310_acl_all_addresses_pruned }}"
              when:
                - "iosrtr_egress_filter_existing_acl in cisc_rt_000310_acl_showrun_existing.stdout | string"
                - iosrtr_egress_acl_filter
                - item not in iosrtr_egress_acl_filter_address_space

            - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Add Deny Entry At End Of ACL." 
              ios_acls:
                config:
                    - afi: ipv4
                      acls:
                      - name: '{{ iosrtr_egress_filter_existing_acl }}'
                        acl_type: extended
                        aces:
                        - grant: deny
                          sequence: 1000
                          protocol: ip
                          source:
                            any: true
                          destination:
                            any: true
                state: merged
              when:
                - "iosrtr_egress_filter_existing_acl in cisc_rt_000310_acl_showrun_existing.stdout | string"

            - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Attach ACL To Interface In iosrtr_egress_internal_interfaces."
              ios_config:
                parents:
                  - "interface {{ item.0 }}"
                lines:
                  - "ip access-group {{ iosrtr_egress_filter_existing_acl }} in"
              with_together: 
                - "{{ cisc_rt_000310_intname }}"
                - "{{ cisc_rt_000310_intstdout }}"
              when:
                - iosrtr_egress_filter_existing_acl in cisc_rt_000310_acl_showrun_existing.stdout | string
                - iosrtr_egress_acl_filter
                - item.0 in iosrtr_egress_internal_interfaces
                - iosrtr_egress_filter_existing_acl not in item.1

            - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Remove ACL from Interface Not In List."
              ios_config:
                parents:
                  - "interface {{ item.0 }}"
                lines:
                  - "no ip access-group {{ iosrtr_egress_filter_existing_acl }} in"
              with_together: 
                - "{{ cisc_rt_000310_intname }}"
                - "{{ cisc_rt_000310_intstdout }}"
              when:
                - iosrtr_egress_filter_existing_acl in cisc_rt_000310_acl_showrun_existing.stdout | string
                - iosrtr_egress_acl_filter
                - item.0 not in iosrtr_egress_internal_interfaces
                - iosrtr_egress_filter_existing_acl in item.1

            - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Remove URPF From Interfaces In List When ACL Filter Used."
              ios_config:
                parents:
                  - "interface {{ item.0 }}"
                lines:
                  - "no ip verify unicast source reachable-via rx"
              with_together: 
                - "{{ cisc_rt_000310_intname }}"
                - "{{ cisc_rt_000310_intstdout }}"
              when:
                - iosrtr_egress_filter_existing_acl in cisc_rt_000310_acl_showrun_existing.stdout | string
                - iosrtr_egress_acl_filter
                - item.0 in iosrtr_egress_internal_interfaces
                - "'ip verify unicast source reachable-via rx' in item.1"

            - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Remove URPF From Interfaces Not In List If URPF Is Set True."
              ios_config:
                parents:
                  - "interface {{ item.0 }}"
                lines:
                  - "no ip verify unicast source reachable-via rx"
              with_together: 
                - "{{ cisc_rt_000310_intname }}"
                - "{{ cisc_rt_000310_intstdout }}"
              when:
                - iosrtr_egress_filter_existing_acl in cisc_rt_000310_acl_showrun_existing.stdout | string
                - iosrtr_egress_acl_filter
                - item.0 not in iosrtr_egress_internal_interfaces
                - "'ip verify unicast source reachable-via rx' in item.1"

            - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Enable URPF On Interfaces In List."
              ios_config:
                parents:
                  - "interface {{ item.0 }}"
                lines:
                  - "ip verify unicast source reachable-via rx"
              with_together: 
                - "{{ cisc_rt_000310_intname }}"
                - "{{ cisc_rt_000310_intstdout }}"
              when:
                - item.0 in iosrtr_egress_internal_interfaces
                - "'ip verify unicast source reachable-via rx' not in item.1"
                - iosrtr_unicast_reverse_path_forwarding

            - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Remove URPF From Interfaces Not In List If URPF Is Set True."
              ios_config:
                parents:
                  - "interface {{ item.0 }}"
                lines:
                  - "no ip verify unicast source reachable-via rx"
              with_together: 
                - "{{ cisc_rt_000310_intname }}"
                - "{{ cisc_rt_000310_intstdout }}"
              when:
                - item.0 not in iosrtr_egress_internal_interfaces
                - "'ip verify unicast source reachable-via rx' in item.1"
                - iosrtr_unicast_reverse_path_forwarding

            - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Remove ACL from Interface On List When URPF Is True."
              ios_config:
                parents:
                  - "interface {{ item.0 }}"
                lines:
                  - "no ip access-group {{ iosrtr_egress_filter_existing_acl }} in"
              with_together: 
                - "{{ cisc_rt_000310_intname }}"
                - "{{ cisc_rt_000310_intstdout }}"
              when:
                - iosrtr_unicast_reverse_path_forwarding
                - item.0 in iosrtr_egress_internal_interfaces
                - iosrtr_egress_filter_existing_acl in item.1

            - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Remove ACL From Interfaces Not Listed In iosrtr_egress_internal_interfaces."
              ios_config:
                parents:
                  - "interface {{ item.0 }}"
                lines:
                  - "no ip access-group {{ iosrtr_egress_filter_existing_acl }} in"
              with_together: 
                - "{{ cisc_rt_000310_intname }}"
                - "{{ cisc_rt_000310_intstdout }}"
              when:
                - iosrtr_unicast_reverse_path_forwarding
                - item.0 not in iosrtr_egress_internal_interfaces
                - iosrtr_egress_filter_existing_acl in item.1

            - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Set Fact For Interfaces With Description."
              set_fact:
                cisc_rt_000310_interface_with_descriptions: "{{ item.name, item.description }}"
              with_items: "{{ cisc_rt_000310_interfaceinfo.gathered }}"

            - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Fix Descriptions For iosrtr_egress_internal_interfaces."
              ios_config:
                parents:
                  - "interface {{ item }}"
                lines:
                  - "description {{ iosrtr_internal_interface_description }}"
              with_items: 
                - "{{ iosrtr_egress_internal_interfaces }}"
              when:
                - cisc_rt_000310_interface_with_descriptions != iosrtr_internal_interface_description     

            - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Remove Description From Interface Not In iosrtr_egress_internal_interface."
              ios_config:
                parents:
                  - "interface {{ item.name }}"
                lines:
                  - "no description"
              when: 
                - item.name not in iosrtr_egress_internal_interfaces
                - item.description is defined
                - item.description == iosrtr_internal_interface_description
              with_items: 
                - "{{ cisc_rt_000310_interfaceinfo.gathered }}"
      when: 
        - not cisc_rt_hardening_one_device
        - "'none' not in iosrtr_egress_filter_existing_acl"
      
    - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Single Router Setup Block."
      block:
        - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Remove User Defined Old ACL."
          ios_acls:
            config:
              - afi: ipv4
                acls:
                  - name: "{{ iosrtr_egress_acl_filter_old }}"
            state: deleted
          when: 
            - "'none' not in iosrtr_egress_acl_filter_old"

        - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Parse User Given ACL From host_var."
          ios_acls:
            running_config: "{{ lookup('file','fles/cisc-rt-000310-acl.txt') }}"
            state: parsed
          register: cisc_rt_000310_acl_parsed
          when: 
            - iosrtr_egress_acl_filter or iosrtr_unicast_reverse_path_forwarding

        - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Convert JSON to DICT For ACL Defined Name."
          set_fact:
            cisc_rt_000310_acl_name: "{{ cisc_rt_000310_acl_parsed.parsed.0.acls.0.name }}"
          when: 
            - iosrtr_egress_acl_filter or iosrtr_unicast_reverse_path_forwarding   
        
        - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Compare And Update ACL."
          ios_acls:
            config: "{{ cisc_rt_000310_acl_parsed.parsed }}"
            state: replaced
          register: cisc_rt_000310_acl_ran
          when: 
            - iosrtr_egress_acl_filter

        - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Print Changed Lines With Debug When ACL Is Changed."
          debug:
            var: cisc_rt_000310_acl_ran.commands
          when: 
            - cisc_rt_000310_acl_ran.changed
            - iosrtr_egress_acl_filter

        - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Gather Interface Facts."
          ios_interfaces:
            state: gathered
          register: cisc_rt_000310_interfaceinfo
          when: 
            - iosrtr_egress_acl_filter or iosrtr_unicast_reverse_path_forwarding

        - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Register Show Run With Interfaces."
          ios_command:
            commands: 
              - "show run | section {{ item.name }}" 
          with_items: "{{ cisc_rt_000310_interfaceinfo.gathered }}"
          register: cisc_rt_000310_interfaceinfo_showrun
          when: 
            - iosrtr_egress_acl_filter or iosrtr_unicast_reverse_path_forwarding

        - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Set Fact For Interface Name And Stdout." 
          set_fact:
            cisc_rt_000310_intname: "{{ cisc_rt_000310_interfaceinfo_showrun.results | map(attribute='item.name') }}"
            cisc_rt_000310_intstdout: "{{ cisc_rt_000310_interfaceinfo_showrun.results | map(attribute='stdout') }}"
          when: 
            - iosrtr_egress_acl_filter or iosrtr_unicast_reverse_path_forwarding

        - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Attach ACL To Interface In iosrtr_egress_internal_interfaces."
          ios_config:
            parents:
              - "interface {{ item.0 }}"
            lines:
              - "ip access-group {{ cisc_rt_000310_acl_name }} in"
          with_together: 
            - "{{ cisc_rt_000310_intname }}"
            - "{{ cisc_rt_000310_intstdout }}"
          when:
            - iosrtr_egress_acl_filter
            - item.0 in iosrtr_egress_internal_interfaces
            - cisc_rt_000310_acl_name not in item.1

        - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Remove ACL from Interface Not In List."
          ios_config:
            parents:
              - "interface {{ item.0 }}"
            lines:
              - "no ip access-group {{ cisc_rt_000310_acl_name }} in"
          with_together: 
            - "{{ cisc_rt_000310_intname }}"
            - "{{ cisc_rt_000310_intstdout }}"
          when:
            - iosrtr_egress_acl_filter
            - item.0 not in iosrtr_egress_internal_interfaces
            - cisc_rt_000310_acl_name in item.1

        - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Remove URPF From Interfaces In List When ACL Filter Used."
          ios_config:
            parents:
              - "interface {{ item.0 }}"
            lines:
              - "no ip verify unicast source reachable-via rx"
          with_together: 
            - "{{ cisc_rt_000310_intname }}"
            - "{{ cisc_rt_000310_intstdout }}"
          when:
            - iosrtr_egress_acl_filter
            - item.0 in iosrtr_egress_internal_interfaces
            - "'ip verify unicast source reachable-via rx' in item.1"

        - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Remove URPF From Interfaces Not In List If URPF Is Set True."
          ios_config:
            parents:
              - "interface {{ item.0 }}"
            lines:
              - "no ip verify unicast source reachable-via rx"
          with_together: 
            - "{{ cisc_rt_000310_intname }}"
            - "{{ cisc_rt_000310_intstdout }}"
          when:
            - iosrtr_egress_acl_filter
            - item.0 not in iosrtr_egress_internal_interfaces
            - "'ip verify unicast source reachable-via rx' in item.1"

        - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Set Fact For Interfaces With Description."
          set_fact:
            cisc_rt_000310_interface_with_descriptions: "{{ item.name, item.description }}"
          with_items: "{{ cisc_rt_000310_interfaceinfo.gathered }}"

        - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Fix Descriptions For iosrtr_egress_internal_interfaces."
          ios_config:
            parents:
              - "interface {{ item }}"
            lines:
              - "description {{ iosrtr_internal_interface_description }}"
          with_items: 
            - "{{ iosrtr_egress_internal_interfaces }}"
          when:
            - cisc_rt_000310_interface_with_descriptions != iosrtr_internal_interface_description     

        - name: "HIGH | CISC-RT-000310 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Remove Description From Interface Not In iosrtr_egress_internal_interface."
          ios_config:
            parents:
              - "interface {{ item.name }}"
            lines:
              - "no description"
          when: 
            - item.name not in iosrtr_egress_internal_interfaces
            - item.description is defined
            - item.description == iosrtr_internal_interface_description
          with_items: 
            - "{{ cisc_rt_000310_interfaceinfo.gathered }}"
      when: 
        - cisc_rt_hardening_one_device
        - "'none' in iosrtr_egress_filter_existing_acl"
  when:
      - cisc_rt_000310
      - not cisc_rt_dodin_backbone
  tags:
      - CISC-RT-000310
      - CAT1
      - CCI-001094
      - SRG-NET-000205-RTR-000014
      - SV-216989r531085_rule
      - V-216989
























# - name: Gather static routes
#   block:
#     - name: Use the Prefix Lists resource module to gather the current config
#       ios_static_routes:
#         config:
#         state: gathered
#       register: ios_static_routes

#     - name: Print Static Routes To Screen
#       debug:
#         msg: "{{ ios_static_routes }}"

#     - name: Create Inventory Directory
#       file:
#         path: "{{ inventory_dir }}/host_vars/{{ inventory_hostname }}"
#         state: directory

#     - name: Write Static Routes Configuration to File
#       copy:
#         content: "{{ ios_static_routes | to_nice_yaml }}"
#         dest: "{{ inventory_dir }}/host_vars/{{ inventory_hostname }}/static_routes.yaml"
#   when:
#       - cisc_rt_static_routes






# - name: Gather Acl Facts
#   block:
#     - name: Use the ACLs resource module to gather the current config
#       ios_acls:
#         state: gathered
#       register: acls 

#     - name: Print ACLs To Screen
#       debug:
#         msg: "{{ acls }}"

#     - name: Create Inventory Directory
#       file:
#         path: "{{ inventory_dir }}/host_vars/{{ inventory_hostname }}"
#         state: directory

#     - name: Write ACL Configuration to File
#       copy:
#         content: "{{ acls | to_nice_yaml }}"
#         dest: "{{ inventory_dir }}/host_vars/{{ inventory_hostname }}/acls.yaml"
#   when:
#       - cisc_rt_acl


# - name: Gather BGP Facts
#   block:
#     - name: Use the bgps resource module to gather the current config
#       ios_bgp_global:
#         config:
#         state: gathered
#       register: bgps

#     - name: Print bgps To Screen
#       debug:
#         msg: "{{ bgps }}"

#     - name: Create Inventory Directory
#       file:
#         path: "{{ inventory_dir }}/host_vars/{{ inventory_hostname }}"
#         state: directory

#     - name: Write bgp Configuration to File
#       copy:
#         content: "{{ bgps | to_nice_yaml }}"
#         dest: "{{ inventory_dir }}/host_vars/{{ inventory_hostname }}/bgp.yaml"
#   when:
#       - cisc_rt_bgp


# - name: Gather Route Maps Facts
#   block:
#     - name: Use the Route Maps resource module to gather the current config
#       ios_route_maps:
#         config:
#         state: gathered
#       register: route_maps

#     - name: Print Route Maps To Screen
#       debug:
#         msg: "{{ route_maps }}"

#     - name: Create Inventory Directory
#       file:
#         path: "{{ inventory_dir }}/host_vars/{{ inventory_hostname }}"
#         state: directory

#     - name: Write Route Maps Configuration to File
#       copy:
#         content: "{{ route_maps | to_nice_yaml }}"
#         dest: "{{ inventory_dir }}/host_vars/{{ inventory_hostname }}/route_maps.yaml"
#   when:
#       - cisc_rt_route_maps



# - name: Gather Prefix Lists Facts
#   block:
#     - name: Use the Prefix Lists resource module to gather the current config
#       ios_prefix_lists:
#         config:
#         state: gathered
#   when:
#       - cisc_rt_prefix_lists

# - name: Gather ospf roesources Facts
#   block:
#     - name: Use the ospf interfaces resource module to gather the current config
#       ios_ospfv2:
#         config:
#         state: gathered
#       register: ios_ospfv2

#     - name: Print ospf interfaces To Screen
#       debug:
#         msg: "{{ ios_ospfv2 }}"

#     - name: Create Inventory Directory
#       file:
#         path: "{{ inventory_dir }}/host_vars/{{ inventory_hostname }}"
#         state: directory

#     - name: Write ospf_resources Configuration to File
#       copy:
#         content: "{{ ios_ospfv2 | to_nice_yaml }}"
#         dest: "{{ inventory_dir }}/host_vars/{{ inventory_hostname }}/ios_ospf_interfaces.yaml"
#   when:
#       - cisc_rt_ospf_maps







# - name: "HIGH | CISC-RT-000730 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure."
#   block:


#     - name: Set Fact For Interfaces With Description
#       set_fact:
#         cisc_rt_000710_interface_with_descriptions: "{{ item.name, item.description }}"
#       with_items: "{{ cisc_rt_000710_interfaceinfo.gathered }}"
#       when: 
#         - item.description is defined

#     - name: Fix Descriptions For iosrtr_egress_internal_interfaces
#       ios_config:
#         parents:
#           - "interface {{ item }}"
#         lines:
#           - "description {{ iosrtr_internal_interface_description }}"
#       with_items: 
#         - "{{ iosrtr_egress_internal_interfaces }}"
#       when: 
#         - cisc_rt_000310_interface_with_descriptions != iosrtr_internal_interface_description

#     - name: Remove Description From Interface Not In iosrtr_egress_internal_interface
#       ios_config:
#         parents:
#           - "interface {{ item.name }}"
#         lines:
#           - "no description"
#       when: 
#         - item.name not in iosrtr_egress_internal_interfaces
#         - item.description is defined
#         - item.description == iosrtr_internal_interface_description
#       with_items: 
#         - "{{ cisc_rt_000310_interfaceinfo.gathered }}"


      
#     - name: "HIGH | CISC-RT-000730 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Remove Old ACL."
#       ios_acls:
#           config:
#               - afi: ipv4
#                 acls:
#                   - name: "{{ iosrtr_block_to_core_acl_name_old }}"
#           state: deleted
#       when: 
#         - iosrtr_000730_acl_update

#     - name: "HIGH | CISC-RT-000730 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Create New ACL."
#       ios_acls:
#           state: replaced
#           config:
#               - afi: ipv4
#                 acls:
#                 - name: "{{ iosrtr_block_to_core_name_new }}"
#                   acl_type: "{{ iosrtr_block_to_core_acl_type }}"
#                   aces:
#                   - grant: '{{ item.grant | default(omit) }}'
#                     sequence: '{{ item.seq | default(omit) }}'
#                     log_input: 
#                       set: '{{ item.log_input | default(omit) }}'
#                     protocol: '{{ item.protocol | default(omit) }}'
#                     protocol_options: 
#                       tcp:
#                         established: '{{ item.protocol_options_tcp_established | default(omit) }}'
#                       icmp:
#                         echo: '{{ item.protocol_options_icmp_echo | default(omit) }}'
#                         echo_reply: '{{ item.protocol_options_icmp_echo_reply | default(omit) }}'
#                     source: 
#                       any: '{{ item.source_any | default(omit) }}'
#                       host: '{{ item.source_host | default(omit) }}'
#                       address: '{{ item.source_address | default(omit) }}'
#                       wildcard_bits: '{{ item.source_wildcard_bits | default(omit) }}'
#                       port_protocol:
#                         eq: '{{ item.source_port_protocol_eq | default(omit) }}' 
#                     destination:
#                       any: '{{ item.destination_any | default(omit) }}'
#                       host: '{{ item.destination_host | default(omit) }}'
#                       address: '{{ item.destination_address | default(omit) }}'
#                       wildcard_bits: '{{ item.destination_wildcard_bits | default(omit) }}'
#                       port_protocol:
#                         eq: '{{ item.destination_port_protocol_eq | default(omit) }}' 
#       with_items: 
#           - "{{ iosrtr_block_to_core_acl }}"
  
    # - name: Acquire Acl Info
    #   ios_acls: 
    #     config:
    #     state: gathered


    
    # - name: configure acl
    #   ios_config:
    #     lines:
    #       - "{{ item }}"
    #     parents: 'ip access-list extended BLOCK_TO_CORE'
    #     match: 
    #   with_items:
    #     - "{{ iosrtr_block_to_core_acl_new }}"
    #   when: iosrtr_block_to_core_acl_new not in ACL.stdout








 
    # - name: Set Fact For Interfaces With Description
    #   set_fact:
    #     cisc_rt_000710_interface_with_descriptions: "{{ item.name, item.description }}"
    #   with_items: "{{ cisc_rt_000710_interfaceinfo.gathered }}"
    #   when: 
    #     - item.description is defined

    # - name: Fix Descriptions For iosrtr_egress_internal_interfaces
    #   ios_config:
    #     parents:
    #       - "interface {{ item }}"
    #     lines:
    #       - "description {{ iosrtr_internal_interface_description }}"
    #   with_items: 
    #     - "{{ iosrtr_egress_internal_interfaces }}"
    #   when: 
    #     - cisc_rt_000310_interface_with_descriptions != iosrtr_internal_interface_description

    # - name: Remove Description From Interface Not In iosrtr_egress_internal_interface
    #   ios_config:
    #     parents:
    #       - "interface {{ item.name }}"
    #     lines:
    #       - "no description"
    #   when: 
    #     - item.name not in iosrtr_egress_internal_interfaces
    #     - item.description is defined
    #     - item.description == iosrtr_internal_interface_description
    #   with_items: 
    #     - "{{ cisc_rt_000310_interfaceinfo.gathered }}"











    # - name: "HIGH | CISC-RT-000730 | PATCH | The Cisco PE router must be configured to block any traffic that is destined to IP core infrastructure. | Attach to CE Or External Interfaces."
    #   ios_config:
    #     parents:
    #       - "interface {{ item }}"
    #     lines:
    #       - "ip access-group {{ iosrtr_block_to_core_name_new }} in"
    #   with_items:
        # - "{{ iosrtr_external_facing_interfaces }}"
  # when:
  #     - cisc_rt_000730
  # tags:
  #     - CISC-RT-000730
  #     - CAT1
  #     - CCI-001097
  #     - SRG-NET-000205-RTR-000007
  #     - SV-216616r531085_rule
  #     - V-216616
