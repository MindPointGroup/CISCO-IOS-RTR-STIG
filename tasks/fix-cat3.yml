---
- name: "LOW | CISC-RT-000060 | PATCH | The Cisco router must be configured to have all inactive interfaces disabled."
  ios_config:
    parents:
      - interface {{ item }}
    lines:
      - shutdown
  with_items:
      - "{{ iosrtr_inactive_interfaces }}"    
  when:
      - cisc_rt_000060
  tags:
      - CISC-RT-000060
      - CAT2
      - CCI-001414
      - SRG-NET-000019-RTR-000007
      - SV-216556r531085_rule
      - V-216556

- name: "LOW | CISC-RT-000070 | PATCH | The Cisco router must be configured to have all non-essential capabilities disabled."
  block:
    - name: "LOW | CISC-RT-000070 | PATCH | The Cisco router must be configured to have all non-essential capabilities disabled. | Show Run For Services."
      ios_command:
        commands: 
          - "show run all | include {{ item }}"
      with_items:
        - "{{ iosrtr_non_essential_serv }}"
      register: iosrtr_000070_show_run_services

    - name: "LOW | CISC-RT-000070 | PATCH | The Cisco router must be configured to have all non-essential capabilities disabled. | Set Fact For Stdout."
      set_fact:
        cisc_rt_000070_intstdout: "{{ iosrtr_000070_show_run_services.results | map(attribute='stdout') }}"

    - name: "LOW | CISC-RT-000070 | PATCH | The Cisco router must be configured to have all non-essential capabilities disabled. | Disable Boot Network."
      ios_config:
        lines: "no boot network"
      when: "'no boot network' in cisc_rt_000070_intstdout | string and 'no boot network' not in cisc_rt_000070_intstdout | string"

    - name: "LOW | CISC-RT-000070 | PATCH | The Cisco router must be configured to have all non-essential capabilities disabled. | Disable ip boot server."
      ios_config:
        lines: "no ip boot server"
      when: "'ip boot server' in cisc_rt_000070_intstdout | string and 'no ip boot server' not in cisc_rt_000070_intstdout | string"
    
    - name: "LOW | CISC-RT-000070 | PATCH | The Cisco router must be configured to have all non-essential capabilities disabled. | Disable ip bootp server."
      ios_config:
        lines: "no ip bootp server"
      when: "'ip bootp server' in cisc_rt_000070_intstdout | string and 'no ip bootp server' not in cisc_rt_000070_intstdout | string"

    - name: "LOW | CISC-RT-000070 | PATCH | The Cisco router must be configured to have all non-essential capabilities disabled. | Disable ip dns server."
      ios_config:
        lines: "no ip dns server"
      when: "'dns server' in cisc_rt_000070_intstdout | string and 'no dns server' not in cisc_rt_000070_intstdout | string"

    - name: "LOW | CISC-RT-000070 | PATCH | The Cisco router must be configured to have all non-essential capabilities disabled. | Disable ip identd."
      ios_config:
        lines: "no ip identd"
      when: "'ip identd' in cisc_rt_000070_intstdout | string and 'no ip identd' not in cisc_rt_000070_intstdout | string"

    - name: "LOW | CISC-RT-000070 | PATCH | The Cisco router must be configured to have all non-essential capabilities disabled. | Disable ip finger."
      ios_config:
        lines: "no ip finger"
      when: "'ip finger' in cisc_rt_000070_intstdout | string and 'no ip finger' not in cisc_rt_000070_intstdout | string"

    - name: "LOW | CISC-RT-000070 | PATCH | The Cisco router must be configured to have all non-essential capabilities disabled. | Disable ip http server."
      ios_config:
        lines: "no ip http server"
      when: "'ip http server' in cisc_rt_000070_intstdout | string and 'no ip http server' not in cisc_rt_000070_intstdout | string"

    - name: "LOW | CISC-RT-000070 | PATCH | The Cisco router must be configured to have all non-essential capabilities disabled. | Disable ip rcmd rcp-enable."
      ios_config:
        lines: "no ip rcmd rcp-enable"
      when: "'ip rcmd rcp-enable' in cisc_rt_000070_intstdout | string and 'no ip rcmd rcp-enable' not in cisc_rt_000070_intstdout | string"

    - name: "LOW | CISC-RT-000070 | PATCH | The Cisco router must be configured to have all non-essential capabilities disabled. | Disable ip rcmd rsh-enable."
      ios_config:
        lines: "no ip rcmd rsh-enable"
      when: "'ip rcmd rsh-enable' in cisc_rt_000070_intstdout | string and 'no ip rcmd rsh-enable' not in cisc_rt_000070_intstdout | string"

    - name: "LOW | CISC-RT-000070 | PATCH | The Cisco router must be configured to have all non-essential capabilities disabled. | Disable service config."
      ios_config:
        lines: "no service config"
      when: "'service config' in cisc_rt_000070_intstdout | string and 'no service config' not in cisc_rt_000070_intstdout | string"
    
    - name: "LOW | CISC-RT-000070 | PATCH | The Cisco router must be configured to have all non-essential capabilities disabled. | Disable service finger."
      ios_config:
        lines: "no service finger"
      when: "'service finger' in cisc_rt_000070_intstdout | string and 'no service finger' not in cisc_rt_000070_intstdout | string"

    - name: "LOW | CISC-RT-000070 | PATCH | The Cisco router must be configured to have all non-essential capabilities disabled. | Disable service service tcp-small-servers."
      ios_config:
        lines: "no service tcp-small-servers"
      when: "'service tcp-small-servers' in cisc_rt_000070_intstdout | string and 'no service tcp-small-servers' not in cisc_rt_000070_intstdout | string"

    - name: "LOW | CISC-RT-000070 | PATCH | The Cisco router must be configured to have all non-essential capabilities disabled. | Disable service udp-small-servers."
      ios_config:
        lines: "no service udp-small-servers"
      when: "'service udp-small-servers' in cisc_rt_000070_intstdout | string and 'no service udp-small-servers' not in cisc_rt_000070_intstdout | string"

    - name: "LOW | CISC-RT-000070 | PATCH | The Cisco router must be configured to have all non-essential capabilities disabled. | Disable service pad."
      ios_config:
        lines: "no service pad"
      when: "'service pad' in cisc_rt_000070_intstdout | string"
  when:
      - cisc_rt_000070
  tags:
      - CISC-RT-000070
      - CAT2
      - CCI-000381
      - SRG-NET-000131-RTR-000035
      - SV-216557r531085_rule
      - V-216557

- name: "LOW | CISC-RT-000160 | PATCH | The Cisco router must be configured to have IP directed broadcast disabled on all interfaces."
  ios_config:
      parents: 
        - "interface {{ item }}"
      lines:
        - "no ip directed-broadcast"
  with_items: 
      - "{{ iosrtr_all_interfaces }}"
  when:
      - cisc_rt_000160
  tags:
      - CISC-RT-000160
      - CAT2
      - CCI-002385
      - SRG-NET-000362-RTR-000112
      - SV-216564r531085_rule
      - V-216564

- name: "LOW | CISC-RT-000200 | PATCH | The Cisco router must be configured to log all packets that have been dropped at interfaces via an ACL."
  ios_acls:
      config:
          - afi: ipv4
            acls:
            - name: '{{ item.name }}'
              acl_type: '{{ item.acl_type }}'
              aces:
              - grant: '{{ item.grant }}'
                protocol: '{{ item.protocol }}'
                source: 
                  any: '{{ item.source_any }}'
                destination:
                  any: '{{ item.destination_any }}'
                log:
                  set: '{{ item.log_set }}'
      state: merged
  with_items: " {{ iosrtr_acl_dropped_packet_log }}"
  when:
      - cisc_rt_000200
  tags:
      - CISC-RT-000200
      - CAT2
      - CCI-000134
      - SRG-NET-000078-RTR-000001
      - SV-216568r531085_rule
      - V-216568

- name: "LOW | CISC-RT-000230 | PATCH | The Cisco router must be configured to disable the auxiliary port unless it is connected to a secured modem providing encryption and authentication."
  block:
    - name: "LOW | CISC-RT-000230 | PATCH | The Cisco router must be configured to disable the auxiliary port unless it is connected to a secured modem providing encryption and authentication. | Check For Aux Line No Exec."
      ios_command:
        commands:
          - show run | section line aux 0 | no exec
      register: cisc_rt_000230_line_aux_output

    - name: "LOW | CISC-RT-000230 | PATCH | The Cisco router must be configured to disable the auxiliary port unless it is connected to a secured modem providing encryption and authentication. | Fix Line Aux No Exec."
      ios_config:
        parents: 
          - line aux 0
        lines:
          - no exec
          - transport input none
      when: "'no exec' not in cisc_rt_000230_line_aux_output.stdout" 
  when:
      - cisc_rt_000230
  tags:
      - CISC-RT-000230
      - CAT2
      - CCI-001414
      - SRG-NET-000019-RTR-000001
      - SV-216571r531085_rule
      - V-216571

- name: "LOW | CISC-RT-000300 | PATCH | The Cisco perimeter router must be configured to not redistribute static routes to an alternate gateway service provider into BGP or an IGP peering with the NIPRNet or to other autonomous systems."
  block:
    - name: "LOW | CISC-RT-000300 | PATCH | The Cisco perimeter router must be configured to not redistribute static routes to an alternate gateway service provider into BGP or an IGP peering with the NIPRNet or to other autonomous systems. | Configure Prefix List For Any Static Routes W/ Alternate Gateway as Next Hop." 
      ios_prefix_lists:
        config:
          - afi: ipv4
            prefix_lists:
              - name: ISP_PREFIX
                description: 
                entries:
                  - action: '{{ item.grant }}'
                    sequence: "{{ item.seq }}"
                    prefix: "{{ item.prefix }}"
        state: merged
      with_items:
        - "{{ iosrtr_static_route_with_alternate_gateway_as_next_hop }}"
      when: 
        - (iosrtr_ospf_staticroute_redistributed) or 
          (iosrtr_eigrp_staticroute_redistributed) or 
          (iosrtr_rip_staticroute_redistributed) or 
          (iosrtr_bgp_staticroute_redistributed)


    - name: "LOW | CISC-RT-000300 | PATCH | The Cisco perimeter router must be configured to not redistribute static routes to an alternate gateway service provider into BGP or an IGP peering with the NIPRNet or to other autonomous systems. | Configure Route Map That Will Deny The Static Routes To ISP."
      ios_route_maps:
          config:
              - entries:
                - sequence: 10
                  action: deny
                  match:
                    ip:
                        address:
                            prefix_lists:
                            - ISP_PREFIX
                - sequence: 20
                  action: permit
                  continue_entry:
                    entry_sequence: 20
                  match:
                    ip:
                        address:
                            prefix_lists:
                route_map: FILTER_ISP_STATIC              
          state: merged
      when: 
        - (iosrtr_ospf_staticroute_redistributed) or 
          (iosrtr_eigrp_staticroute_redistributed) or 
          (iosrtr_rip_staticroute_redistributed) or 
          (iosrtr_bgp_staticroute_redistributed)

    - name: "LOW | CISC-RT-000300 | PATCH | The Cisco perimeter router must be configured to not redistribute static routes to an alternate gateway service provider into BGP or an IGP peering with the NIPRNet or to other autonomous systems. | Apply Route Map to OSPF."
      ios_config:
        parents:
          - router ospf {{ item }}
        lines:
          - redistribute static route-map FILTER_ISP_STATIC
      with_items:
      - "{{ iosrtr_ospf_process_number }}"
      when: 
        - iosrtr_ospf_staticroute_redistributed

    - name: "LOW | CISC-RT-000300 | PATCH | The Cisco perimeter router must be configured to not redistribute static routes to an alternate gateway service provider into BGP or an IGP peering with the NIPRNet or to other autonomous systems. | Apply Route Map to EIGRP."
      ios_config:
        parents:
          - router eigrp {{ item }}
        lines:
          - redistribute static route-map FILTER_ISP_STATIC
      with_items:
          - "{{ iosrtr_eigrp_as_number }}"
      when: 
        - iosrtr_eigrp_staticroute_redistributed

    - name: "LOW | CISC-RT-000300 | PATCH | The Cisco perimeter router must be configured to not redistribute static routes to an alternate gateway service provider into BGP or an IGP peering with the NIPRNet or to other autonomous systems. Apply Route Map to RIP."
      ios_config:
        parents:
            - router rip 
        lines:
            - redistribute static route-map FILTER_ISP_STATIC
      when: 
          - iosrtr_rip_staticroute_redistributed

    - name: "LOW | CISC-RT-000300 | PATCH | The Cisco perimeter router must be configured to not redistribute static routes to an alternate gateway service provider into BGP or an IGP peering with the NIPRNet or to other autonomous systems. | Apply Route Map to BGP."
      ios_config:
        parents:
            - router bgp {{ item }}
        lines:
            - redistribute static route-map FILTER_ISP_STATIC
      with_items:
      - "{{ iosrtr_bgp_as_router_number }}"
      when: 
          - iosrtr_bgp_staticroute_redistributed
  when:
      - cisc_rt_000300
      - not cisc_rt_dodin_backbone
  tags:
      - CISC-RT-000300
      - CAT2
      - CCI-001414
      - SRG-NET-000019-RTR-000010
      - SV-216578r531085_rule	
      - V-216578

- name: "LOW | CISC-RT-000360 | PATCH | The Cisco perimeter router must be configured to have Link Layer Discovery Protocol (LLDP) disabled on all external interfaces."
  block:
      - name: "LOW | CISC-RT-000360 | PATCH | The Cisco perimeter router must be configured to have Link Layer Discovery Protocol (LLDP) disabled on all external interfaces. | Get Global LLDP Status."
        ios_command:
          commands :
            - show run | include lldp run
        register: cisc_rt_000360_lldp_status 

      - name: "LOW | CISC-RT-000360 | PATCH | The Cisco perimeter router must be configured to have Link Layer Discovery Protocol (LLDP) disabled on all external interfaces. | Disable LLDP On External Interfaces If Global Enabled."
        ios_config:
          parents:
            - interface {{ item }}
          lines:
            - no lldp transmit
        with_items: "{{ iosrtr_lldp_external_interfaces }}"
        when: "'lldp run' in cisc_rt_000360_lldp_status.stdout"
  when:
      - cisc_rt_000360
      - not cisc_rt_dodin_backbone
  tags:
      - CISC-RT-000360
      - CAT2
      - CCI-002403
      - SRG-NET-000364-RTR-000111
      - SV-216584r531085_rule
      - V-216584

- name: "LOW | CISC-RT-000370 | PATCH | The Cisco perimeter router must be configured to have Cisco Discovery Protocol (CDP) disabled on all external interfaces."
  block:
      - name: "LOW | CISC-RT-000370 | PATCH | The Cisco perimeter router must be configured to have Cisco Discovery Protocol (CDP) disabled on all external interfaces. | Get Global CDP Status."
        ios_command:
          commands:
            - show run | include no cdp run
        register: cisc_rt_000360_cdp_status 

      - name: "LOW | CISC-RT-000370 | PATCH | The Cisco perimeter router must be configured to have Cisco Discovery Protocol (CDP) disabled on all external interfaces. | Disable CDP On External Interfaces If Global Enabled."
        ios_config:
          parents:
            - interface {{ item }}
          lines:
            - no cdp enable
        with_items: "{{ iosrtr_cdp_external_interfaces }}"
        when: "'no cdp run' not in cisc_rt_000360_cdp_status.stdout"
  when:
      - cisc_rt_000370
      - not cisc_rt_dodin_backbone 
  tags:
      - CISC-RT-000370
      - CAT2
      - CCI-002403
      - SRG-NET-000364-RTR-000111
      - SV-216585r531085_rule
      - V-216585

- name: "LOW | CISC-RT-000540 | PATCH | The Cisco BGP router must be configured to reject route advertisements from BGP peers that do not list their autonomous system (AS) number as the first AS in the AS_PATH attribute."
  block:
      - name: "LOW | CISC-RT-000540 | PATCH | The Cisco BGP router must be configured to reject route advertisements from BGP peers that do not list their autonomous system (AS) number as the first AS in the AS_PATH attribute. | Search For NO BGP Enforce-first-as."
        ios_command:
          commands:
            - show run | include no bgp enforce-first-as
        register: cisc_rt_000540_no_bgp_enforce_first_as

      - name: "LOW | CISC-RT-000540 | PATCH | The Cisco BGP router must be configured to reject route advertisements from BGP peers that do not list their autonomous system (AS) number as the first AS in the AS_PATH attribute. | Remove no bgp enforce-first-as If Found."
        ios_config:
          parents:
            - router bgp {{ iosrtr_bgp_autonomous_system_number }}
          commands: 
            - bgp enforce-first-as
        when: "'' not in cisc_rt_000540_no_bgp_enforce_first_as.stdout"    
  when:
      - cisc_rt_000540
  tags:
      - CISC-RT-000540
      - CAT2
      - CCI-000032
      - SRG-NET-000018-RTR-000006
      - SV-216602r531085_rule
      - V-216602

- name: "LOW | CISC-RT-000550 | PATCH | The Cisco BGP router must be configured to reject route advertisements from CE routers with an originating AS in the AS_PATH attribute that does not belong to that customer."
  block:
    - name: "LOW | CISC-RT-000550 | PATCH | The Cisco BGP router must be configured to reject route advertisements from CE routers with an originating AS in the AS_PATH attribute that does not belong to that customer. | Add AS-PATH Access Lists."
      ios_config:
        commands:
          - ip as-path access-list 10 permit ^{{iosrtr_receive_only_routes_originated_from_as}}$
          - ip as-path access-list 10 deny .*
  
    - name: "LOW | CISC-RT-000550 | PATCH | The Cisco BGP router must be configured to reject route advertisements from CE routers with an originating AS in the AS_PATH attribute that does not belong to that customer. | Apply Access List Inbound."
      ios_config:
        parents:
          - router bgp {{ iosrtr_bgp_autonomous_system_number }}
        commands:
          - neighbor {{ item }} filter-list 10 in
      with_items:
        - "{{ iosrtr_bgp_neighbor_address }}"
  when:
      - cisc_rt_000550
      - not cisc_rt_dodin_backbone
  tags:
      - CISC-RT-000550
      - CAT2
      - CCI-000032
      - SRG-NET-000018-RTR-000010
      - SV-216603r531085_rule
      - V-216603

- name: "LOW | CISC-RT-000570 | PATCH | The Cisco BGP router must be configured to limit the prefix size on any inbound route advertisement to /24 or the least significant prefixes issued to the customer."
  block:
    - name: "LOW | CISC-RT-000570 | PATCH | The Cisco BGP router must be configured to limit the prefix size on any inbound route advertisement to /24 or the least significant prefixes issued to the customer. | Configure Router To Limit Prefix Size"
      ios_prefix_lists:
        config:
          - afi: ipv4
            prefix_lists:
              - name: FILTER_PREFIX_LENGTH
                description: 
                entries:
                  - action: "{{ item.action }}"
                    prefix: "{{ item.prefix }}"
                    ge: "{{ item.ge | default(omit) }}"
                    le: "{{ item.le | default(omit) }}"
                    sequence: "{{ item.seq }}"
      with_items:
        - "{{ osrtr_prefix_limit_data }}"
    
    - name: "LOW | CISC-RT-000570 | PATCH | The Cisco BGP router must be configured to limit the prefix size on any inbound route advertisement to /24 or the least significant prefixes issued to the customer. | Apply To All eBGP (Exterior Border Gateway Protocol) Peer Neighbors."
      ios_config:
        parents: 
          - router bgp {{ iosrtr_local_bgp_autonomous_system_number }}
        lines:
          - neighbor {{ item }} prefix-list FILTER_PREFIX_LENGTH in
      with_items:
        - "{{ iosrtr_ebgp_neighbors }}"
  when:
      - cisc_rt_000570
      - not cisc_rt_dodin_backbone
  tags:
      - CISC-RT-000570
      - CAT2
      - CCI-002385
      - SRG-NET-000362-RTR-000118
      - SV-216605r531085_rule
      - V-216605

- name: "LOW | CISC-RT-000580 | PATCH | The Cisco BGP router must be configured to use its loopback address as the source address for iBGP peering sessions."
  ios_bgp:
    config:
      bgp_as: "{{ iosrtr_local_bgp_autonomous_system_number }}"
      address_family:
        - afi: ipv4
      neighbors:
        - neighbor: "{{ item.0 }}"
          remote_as: "{{ item.1 }}"
          update_source: "{{ iosrtr_loopback_interface }}"
    operation: replaced
  with_together:
    - "{{ iosrtr_ibgp_neighbor_loopback }}"
    - "{{ iosrtr_remote_as_number }}"
  when:
      - cisc_rt_000580
  tags:
      - CISC-RT-000580
      - CAT2
      - CCI-000366
      - SRG-NET-000512-RTR-000001
      - SV-216606r531085_rule
      - V-216606

- name: "LOW | CISC-RT-000590 | PATCH | The Cisco MPLS router must be configured to use its loopback address as the source address for LDP peering sessions."
  ios_config:
    lines:
      -  mpls ldp router-id {{ iosrtr_loopback_interface_source }}
  when:
      - cisc_rt_000590
  tags:
      - CISC-RT-000590
      - CAT2
      - CCI-000366
      - SRG-NET-000512-RTR-000002
      - SV-216607r531085_rule	
      - V-216607

- name: "LOW | CISC-RT-000600 | PATCH | The Cisco MPLS router must be configured to synchronize IGP and LDP to minimize packet loss when an IGP adjacency is established prior to LDP peers completing label exchange."
  block:
    - name: "LOW | CISC-RT-000600 | PATCH | The Cisco MPLS router must be configured to synchronize IGP and LDP to minimize packet loss when an IGP adjacency is established prior to LDP peers completing label exchange. | Configure the MPLS router to synchronize IGP and LDP In OSPF."
      ios_config:
        parents:
          - router ospf {{ item }}
        lines:
          - mpls ldp sync
      with_items: 
          - "{{ iosrtr_opsf_process_id }}"
      when:
        - iosrtr_ospf_ldp_sync

    - name: "LOW | CISC-RT-000600 | PATCH | The Cisco MPLS router must be configured to synchronize IGP and LDP to minimize packet loss when an IGP adjacency is established prior to LDP peers completing label exchange. | Configure the MPLS router to synchronize IGP and LDP In IS-IS."
      ios_config:
        parents: 
          - router isis
        lines:
          - mpls ldp sync
      when: 
        - iosrtr_isis_ldp_sync
  when:
      - cisc_rt_000600
  tags:
      - CISC-RT-000600
      - CAT2
      - CCI-000366
      - SRG-NET-000512-RTR-000003
      - SV-216608r531085_rule
      - V-216608

- name: "LOW | CISC-RT-000610 | PATCH | The MPLS router with RSVP-TE enabled must be configured with message pacing to adjust maximum burst and maximum number of RSVP messages to an output queue based on the link speed and input queue size of adjacent core routers."
  block:
    - name: "LOW | CISC-RT-000610 | PATCH | The MPLS router with RSVP-TE enabled must be configured with message pacing to adjust maximum burst and maximum number of RSVP messages to an output queue based on the link speed and input queue size of adjacent core routers. | Enable MPLS Traffic-Eng Globally."
      ios_config:
        lines:
          - mpls traffic-eng tunnels

    - name: "LOW | CISC-RT-000610 | PATCH | The MPLS router with RSVP-TE enabled must be configured with message pacing to adjust maximum burst and maximum number of RSVP messages to an output queue based on the link speed and input queue size of adjacent core routers. | Apply To At Least One Interface."
      ios_config:
        parents: 
          - interface {{ item }}
        lines:
          - mpls traffic-eng tunnels
      with_items:
          - "{{ iosrtr_interfaces_mpls_traffic_eng_tunnels }}"

    # Checking to see if limit is a option on router if not it skips variable.
    - name: "LOW | CISC-RT-000610 | PATCH | The MPLS router with RSVP-TE enabled must be configured with message pacing to adjust maximum burst and maximum number of RSVP messages to an output queue based on the link speed and input queue size of adjacent core routers. | Check Rate Limit."
      ios_config:
        lines:
          - ip rsvp signalling rate-limit limit
      changed_when: false
      register: check_rate_limit_feature
      failed_when: check_rate_limit_feature.rc not in [ 0, 1 ]

    - name: "LOW | CISC-RT-000610 | PATCH | The MPLS router with RSVP-TE enabled must be configured with message pacing to adjust maximum burst and maximum number of RSVP messages to an output queue based on the link speed and input queue size of adjacent core routers. | Set fact For Check Rate Limit."
      set_fact:
        limit_allowed: false
      when: '"Invalid input detected at" in check_rate_limit_feature.module_stderr'

    - name: "LOW | CISC-RT-000610 | PATCH | The MPLS router with RSVP-TE enabled must be configured with message pacing to adjust maximum burst and maximum number of RSVP messages to an output queue based on the link speed and input queue size of adjacent core routers. | Apply IP RSV Signalling Rate Limit."
      ios_config:
        lines:
          - ip rsvp signalling rate-limit {{ item.period | default(omit) }} {{ item.burst | default(omit) }} {{ item.maxsize | default(omit) }} {% if limit_allowed %}{{ item.limit }}{% endif %}
      with_items:
        - "{{ iosrtr_ip_rsvp_signalling_rate_limit }}"
  when:
      - cisc_rt_000610
  tags:
      - CISC-RT-000610
      - CAT2
      - CCI-001095
      - SRG-NET-000193-RTR-000001
      - SV-216609r531085_rule
      - V-216609

- name: |
        "LOW | CISC-RT-000760 | PATCH | The Cisco PE router must be configured to enforce a Quality-of-Service (QoS) policy in accordance with the QoS DODIN Technical Profile."
        "LOW | CISC-RT-000770 | PATCH | The Cisco PE router must be configured to implement a Quality-of-Service (QoS) policy in accordance with the QoS DODIN Technical Profile."
  block:
    - name: | 
            "LOW | CISC-RT-000760 | PATCH | The Cisco PE router must be configured to enforce a Quality-of-Service (QoS) policy in accordance with the QoS DODIN Technical Profile."
            "LOW | CISC-RT-000770 | PATCH | The Cisco PE router must be configured to implement a Quality-of-Service (QoS) policy in accordance with the QoS DODIN Technical Profile. | Configure Class Maps And DSCP."
      ios_config:
        parents:
            - class-map match-all {{ item.0 }}
        lines:
            - match ip dscp {{ item.1 }}
      with_together:
        - "{{ iosrtr_classmap_name }}"
        - "{{ iosrtr_classmap_dscp_value }}"

    - name: |
            "LOW | CISC-RT-000760 | PATCH | The Cisco PE router must be configured to enforce a Quality-of-Service (QoS) policy in accordance with the QoS DODIN Technical Profile."
            "LOW | CISC-RT-000770 | PATCH | The Cisco PE router must be configured to implement a Quality-of-Service (QoS) policy in accordance with the QoS DODIN Technical Profile. | Configure A Policy Map."
      ios_config:
        parents: 
          - policy-map QOS_POLICY
          - class {{ item.0 }}
        lines:
          - priority percent {{ item.1 }}
      with_together:
        - "{{ iosrtr_policymap_name }}"
        - "{{ iosrtr_policymap_bandwidth_percentage }}"
      
    - name: |
            "LOW | CISC-RT-000760 | PATCH | The Cisco PE router must be configured to enforce a Quality-of-Service (QoS) policy in accordance with the QoS DODIN Technical Profile."
            "LOW | CISC-RT-000770 | PATCH | The Cisco PE router must be configured to implement a Quality-of-Service (QoS) policy in accordance with the QoS DODIN Technical Profile. | Apply Service Policy To All Interfaces."
      ios_config:
        parents:
          - interface {{ item }}
        lines:
          - max-reserved-bandwidth 85
          - service-policy output QOS_POLICY
      with_items:
          - "{{ iosrtr_all_interfaces }}"    
  when:
      - cisc_rt_000760 or 
        cisc_rt_000770 
  tags:
      - CISC-RT-000760
      - CISC-RT-000770
      - CAT2
      - CCI-001095
      - SRG-NET-000193-RTR-000113
      - SRG-NET-000193-RTR-000114
      - SV-216619r531085_rule
      - SV-216620r531085_rule
      - V-216619
      - V-216620

- name: "LOW | CISC-RT-000810 | PATCH | The Cisco multicast edge router must be configured to establish boundaries for administratively scoped multicast traffic."
  block:
    - name: "LOW | CISC-RT-000810 | PATCH | The Cisco multicast edge router must be configured to establish boundaries for administratively scoped multicast traffic. | Remove Old Multicast Traffic ACL."
      ios_acls:
          config:
              - afi: ipv4
                acls:
                  - name: "{{ iosrtr_scoped_multicast_traffic_access_list_name_old }}"
          state: deleted

    - name: "LOW | CISC-RT-000810 | PATCH | The Cisco multicast edge router must be configured to establish boundaries for administratively scoped multicast traffic. | Setup New ACL For Mutlicast."
      ios_acls:
          config:
              - afi: ipv4
                acls:
                - name: "{{ iosrtr_scoped_multicast_traffic_access_list_name }}"
                  acl_type: "{{ iosrtr_scoped_multicast_traffic_access_list_type }}"
                  aces:
                  - grant: '{{ item.grant | default(omit) }}'
                    sequence: '{{ item.seq | default(omit) }}'
                    protocol:
                    source: 
                      any: '{{ item.source_any | default(omit) }}'
                      host: '{{ item.source_host | default(omit) }}'
                      address: '{{ item.source_address | default(omit) }}'
                      wildcard_bits: '{{ item.source_wildcard_bits | default(omit) }}'
      with_items:
        - "{{ iosrtr_scoped_multicast_traffic_acl }}"

    - name: "LOW | CISC-RT-000810 | PATCH | The Cisco multicast edge router must be configured to establish boundaries for administratively scoped multicast traffic. | Apply To Interfaces."
      ios_config:
        parents:
            - interface {{ item }}
        lines:
            - ip multicast boundary {{ iosrtr_scoped_multicast_traffic_access_list_name }}
      with_items:
        - "{{ iosrtr_multicast_boundary_interfaces }}"
  when:
      - cisc_rt_000810
  tags:
      - CISC-RT-000810
      - CAT2
      - CCI-001414
      - SRG-NET-000019-RTR-000005
      - SV-216624r531085_rule
      - V-216624

- name: |
        "LOW | CISC-RT-000820 | PATCH | The Cisco multicast Rendezvous Point (RP) router must be configured to limit the multicast forwarding cache so that its resources are not saturated by managing an overwhelming number of Protocol Independent Multicast (PIM) and Multicast Source Discovery Protocol (MSDP) source-active entries."
        "LOW | CISC-RT-000830 | PATCH | The Cisco multicast Rendezvous Point (RP) router must be configured to filter Protocol Independent Multicast (PIM) Register messages received from the Designated Router (DR) for any undesirable multicast groups and sources."
  block:
    - name: |
            "LOW | CISC-RT-000820 | PATCH | The Cisco multicast Rendezvous Point (RP) router must be configured to limit the multicast forwarding cache so that its resources are not saturated by managing an overwhelming number of Protocol Independent Multicast (PIM) and Multicast Source Discovery Protocol (MSDP) source-active entries. | Remove Old PIM Access Control List."
            "LOW | CISC-RT-000830 | PATCH | The Cisco multicast Rendezvous Point (RP) router must be configured to filter Protocol Independent Multicast (PIM) Register messages received from the Designated Router (DR) for any undesirable multicast groups and sources."
      ios_acls:
          config:
              - afi: ipv4
                acls:
                  - name: "{{ iosrtr_pim_register_filter_acl_name_old }}"
          state: deleted
      when: cisc_rt_000820 or cisc_rt_000830

    - name: |
            "LOW | CISC-RT-000820 | PATCH | The Cisco multicast Rendezvous Point (RP) router must be configured to limit the multicast forwarding cache so that its resources are not saturated by managing an overwhelming number of Protocol Independent Multicast (PIM) and Multicast Source Discovery Protocol (MSDP) source-active entries. | Creates The New PIM Access Control List."         
            "LOW | CISC-RT-000830 | PATCH | The Cisco multicast Rendezvous Point (RP) router must be configured to filter Protocol Independent Multicast (PIM) Register messages received from the Designated Router (DR) for any undesirable multicast groups and sources."
      ios_acls:
          config:
              - afi: ipv4
                acls:
                - name: "{{ iosrtr_pim_register_filter_acl_name_new }}"
                  acl_type: "{{ iosrtr_pim_register_filter_acl_type }}"
                  aces:
                  - grant: '{{ item.grant | default(omit) }}'
                    sequence: '{{ item.seq | default(omit) }}'
                    protocol: '{{ item.protocol | default(omit) }}'
                    source: 
                      any: '{{ item.source_any | default(omit) }}'
                      host: '{{ item.source_host | default(omit) }}'
                      address: '{{ item.source_address | default(omit) }}'
                      wildcard_bits: '{{ item.source_wildcard_bits | default(omit) }}'
                    destination:
                      any: '{{ item.destination_any | default(omit) }}'
                      host: '{{ item.destination_host | default(omit) }}'
                      address: '{{ item.destination_address | default(omit) }}'
                      wildcard_bits: '{{ item.destination_wildcard_bits | default(omit) }}'
      when: cisc_rt_000820 or cisc_rt_000830
      with_items:
        - "{{ iosrtr_pim_register_filter_traffic_acl }}"

    - name: "LOW | CISC-RT-000820 | PATCH | The Cisco multicast Rendezvous Point (RP) router must be configured to limit the multicast forwarding cache so that its resources are not saturated by managing an overwhelming number of Protocol Independent Multicast (PIM) and Multicast Source Discovery Protocol (MSDP) source-active entries. | Registers accept filter For PIM."
      ios_config:
        lines: 
          - ip pim accept-register list {{ iosrtr_pim_register_filter_acl_name_new }}
      when: cisc_rt_000820 or cisc_rt_000830


    - name: "LOW | CISC-RT-000820 | PATCH | The Cisco multicast Rendezvous Point (RP) router must be configured to limit the multicast forwarding cache so that its resources are not saturated by managing an overwhelming number of Protocol Independent Multicast (PIM) and Multicast Source Discovery Protocol (MSDP) source-active entries. | Check For Limiting PIM Register Messages."
      block:
        - name: "LOW | CISC-RT-000820 | PATCH | The Cisco multicast Rendezvous Point (RP) router must be configured to limit the multicast forwarding cache so that its resources are not saturated by managing an overwhelming number of Protocol Independent Multicast (PIM) and Multicast Source Discovery Protocol (MSDP) source-active entries. | Show Run For PIM Register Messages."
          ios_command:
            commands: "show run | include ip pim register-rate-limit"
          register: iosrtr_pim_register_rate_limit_check

        - name: "LOW | CISC-RT-000820 | PATCH | The Cisco multicast Rendezvous Point (RP) router must be configured to limit the multicast forwarding cache so that its resources are not saturated by managing an overwhelming number of Protocol Independent Multicast (PIM) and Multicast Source Discovery Protocol (MSDP) source-active entries. | No pim register-rate-limit Check Defined Warning Message."
          debug:
            msg: 
              - "Warning!!! The router is not configured to rate limit the number of PIM register messages."
              - "To Fix this error please define a value in iosrtr_pim_register_rate_limit in defaults main."
          when: "'ip pim register-rate-limit' not in iosrtr_pim_register_rate_limit_check.stdout | string"

        - name: "LOW | CISC-RT-000820 | PATCH | The Cisco multicast Rendezvous Point (RP) router must be configured to limit the multicast forwarding cache so that its resources are not saturated by managing an overwhelming number of Protocol Independent Multicast (PIM) and Multicast Source Discovery Protocol (MSDP) source-active entries. | Create Control Warning For End Of Play."
          set_fact:
            control_number:
              - "{{ control_number }} + [ CISC-RT-000820 - Configure Or Turn On CISC-RT-000850 ]"
            warn_count: "{{ warn_count|int + 1 }}"
          when: "'ip pim register-rate-limit' not in iosrtr_pim_register_rate_limit_check.stdout | string"
      when: cisc_rt_000820
    
    - name: "LOW | CISC-RT-000820 | PATCH | The Cisco multicast Rendezvous Point (RP) router must be configured to limit the multicast forwarding cache so that its resources are not saturated by managing an overwhelming number of Protocol Independent Multicast (PIM) and Multicast Source Discovery Protocol (MSDP) source-active entries. | Remove Old MSDP Control Access List."
      ios_acls:
          config:
              - afi: ipv4
                acls:
                  - name: "{{ iosrtr_msdp_known_peers_acl_name_old }}"
          state: deleted 
      when: cisc_rt_000820

    - name: "LOW | CISC-RT-000820 | PATCH | The Cisco multicast Rendezvous Point (RP) router must be configured to limit the multicast forwarding cache so that its resources are not saturated by managing an overwhelming number of Protocol Independent Multicast (PIM) and Multicast Source Discovery Protocol (MSDP) source-active entries. | Creates The New MSDP Access Control List."
      ios_acls:
          config:
              - afi: ipv4
                acls:
                - name: "{{ iosrtr_msdp_known_peers_acl_name_new }}"
                  acl_type: "{{ iosrtr_msdp_known_peers_acl_type }}"
                  aces:
                  - grant: '{{ item.grant | default(omit) }}'
                    sequence: '{{ item.seq | default(omit) }}'
                    protocol: '{{ item.protocol | default(omit) }}'
                    protocol_options: 
                      tcp:
                        established: '{{ item.destination_protocol_options_tcp_established | default(omit) }}'
                    source: 
                      any: '{{ item.source_any | default(omit) }}'
                      host: '{{ item.source_host | default(omit) }}'
                      address: '{{ item.source_address | default(omit) }}'
                      wildcard_bits: '{{ item.source_wildcard_bits | default(omit) }}'
                    destination:
                      any: '{{ item.destination_any | default(omit) }}'
                      host: '{{ item.destination_host | default(omit) }}'
                      address: '{{ item.destination_address | default(omit) }}'
                      wildcard_bits: '{{ item.destination_wildcard_bits | default(omit) }}'
                      port_protocol:
                        eq: '{{ item.destination_port_protocol_eq | default(omit) }}' 
      with_items:
        - "{{ iosrtr_msdp_known_peers_acl }}"
      when: cisc_rt_000820
  when:
      - cisc_rt_000820 or cisc_rt_000830
  tags:
      - CISC-RT-000820
      - CISC-RT-000830
      - CAT2
      - CCI-002385
      - CCI-001414
      - SRG-NET-000362-RTR-000120
      - SRG-NET-000019-RTR-000013
      - SV-216625r531085_rule
      - SV-216626r531085_rule	
      - V-216625
      - V-216626

- name: "LOW | CISC-RT-000840 | PATCH | The Cisco multicast Rendezvous Point (RP) router must be configured to filter Protocol Independent Multicast (PIM) Join messages received from the Designated Router (DR) for any undesirable multicast groups."
  block:
    - name: "LOW | CISC-RT-000840 | PATCH | The Cisco multicast Rendezvous Point (RP) router must be configured to filter Protocol Independent Multicast (PIM) Join messages received from the Designated Router (DR) for any undesirable multicast groups. | Remove Old PIM Join Filter."
      ios_acls:
          config:
              - afi: ipv4
                acls:
                  - name: "{{ iosrtr_filter_pim_joins_acl_name_old }}"
          state: deleted

    - name: "LOW | CISC-RT-000840 | PATCH | The Cisco multicast Rendezvous Point (RP) router must be configured to filter Protocol Independent Multicast (PIM) Join messages received from the Designated Router (DR) for any undesirable multicast groups. | Create New PIM Filter Joins Access Control List."
      ios_acls:
          config:
              - afi: ipv4
                acls:
                - name: "{{ iosrtr_filter_pim_joins_acl_name }}"
                  acl_type: "{{ iosrtr_filter_pim_joins_acl_type }}"
                  aces:
                  - grant: '{{ item.grant | default(omit) }}'
                    sequence: '{{ item.seq | default(omit) }}'
                    protocol:
                    source: 
                      any: '{{ item.source_any | default(omit) }}'
                      host: '{{ item.source_host | default(omit) }}'
                      address: '{{ item.source_address | default(omit) }}'
                      wildcard_bits: '{{ item.source_wildcard_bits | default(omit) }}'
      with_items:
        - "{{ iosrtr_pim_join_filter_acl }}"

    - name: "LOW | CISC-RT-000840 | PATCH | The Cisco multicast Rendezvous Point (RP) router must be configured to filter Protocol Independent Multicast (PIM) Join messages received from the Designated Router (DR) for any undesirable multicast groups. | Attach Join Messages ACL To Rendezvous Point Router Address."
      ios_config:
        lines: ip pim accept-rp {{ iosrtr_rendezvous_point_router_ip_address_for_group }} {{ iosrtr_filter_pim_joins_access_list_name }}     
  when:
      - cisc_rt_000840
  tags:
      - CISC-RT-000840
      - CAT2
      - CCI-001414
      - SRG-NET-000019-RTR-000014
      - SV-216627r531085_rule	
      - V-216627

- name: "LOW | CISC-RT-000860 | PATCH | The Cisco multicast Designated Router (DR) must be configured to filter the Internet Group Management Protocol (IGMP) and Multicast Listener Discovery (MLD) Report messages to allow hosts to join only multicast groups that have been approved by the organization."
  block:
    - name: "LOW | CISC-RT-000860 | PATCH | The Cisco multicast Designated Router (DR) must be configured to filter the Internet Group Management Protocol (IGMP) and Multicast Listener Discovery (MLD) Report messages to allow hosts to join only multicast groups that have been approved by the organization. | Remove Old IGMP Filter."
      ios_acls:
          config:
              - afi: ipv4
                acls:
                  - name: "{{ iosrtr_filter_igmp_joins_acl_name_old }}"
          state: deleted

    - name: "LOW | CISC-RT-000860 | PATCH | The Cisco multicast Designated Router (DR) must be configured to filter the Internet Group Management Protocol (IGMP) and Multicast Listener Discovery (MLD) Report messages to allow hosts to join only multicast groups that have been approved by the organization. | Create New IGMP Join Filter Access List."
      ios_acls:
          config:
              - afi: ipv4
                acls:
                - name: "{{ iosrtr_filter_igmp_joins_acl_name }}"
                  acl_type: "{{ iosrtr_filter_igmp_joins_acl_type }}"
                  aces:
                  - grant: '{{ item.grant | default(omit) }}'
                    sequence: '{{ item.seq | default(omit) }}'
                    protocol:
                    source: 
                      any: '{{ item.source_any | default(omit) }}'
                      host: '{{ item.source_host | default(omit) }}'
                      address: '{{ item.source_address | default(omit) }}'
                      wildcard_bits: '{{ item.source_wildcard_bits | default(omit) }}'
      with_items:
        - "{{ iosrtr_igmp_join_filter_acl }}"

    - name: "LOW | CISC-RT-000860 | PATCH | The Cisco multicast Designated Router (DR) must be configured to filter the Internet Group Management Protocol (IGMP) and Multicast Listener Discovery (MLD) Report messages to allow hosts to join only multicast groups that have been approved by the organization. | Apply Filter To All Host facing Interfaces."
      ios_config:
        parents:
            - interface {{ item }}
        lines:
            - ip igmp access-group {{ iosrtr_filter_igmp_joins_acl_name }}
      with_items:
        - "{{ iosrtr_igmp_join_filter_host_facing_interfaces }}"
  when:
      - cisc_rt_000860
  tags:
      - CISC-RT-000860
      - CAT2
      - CCI-002403
      - SRG-NET-000364-RTR-000114
      - SV-216629r531085_rule	
      - V-216629

- name: "LOW | CISC-RT-000920 | PATCH | The Cisco Multicast Source Discovery Protocol (MSDP) router must be configured to filter received source-active multicast advertisements for any undesirable multicast groups and sources."
  block:
    - name: CISC-RT-000920 | PATCH | The Cisco Multicast Source Discovery Protocol (MSDP) router must be configured to filter received source-active multicast advertisements for any undesirable multicast groups and sources. | Remove Old MSDP SA Filter."
      ios_acls:
          config:
              - afi: ipv4
                acls:
                  - name: "{{ iosrtr_inbound_msdp_sa_filter_acl_name_old }}"
          state: deleted

    - name: "LOW | CISC-RT-000920 | PATCH | The Cisco Multicast Source Discovery Protocol (MSDP) router must be configured to filter received source-active multicast advertisements for any undesirable multicast groups and sources. | Create New MSDP SA Filter Access List."
      ios_acls:
          config:
              - afi: ipv4
                acls:
                - name: "{{ iosrtr_inbound_msdp_sa_filter_acl_name }}"
                  acl_type: "{{ iosrtr_inbound_msdp_sa_filter_acl_type }}"
                  aces:
                  - grant: '{{ item.grant | default(omit) }}'
                    sequence: '{{ item.seq | default(omit) }}'
                    protocol: '{{ item.protocol | default(omit) }}'
                    source: 
                      any: '{{ item.source_any | default(omit) }}'
                      host: '{{ item.source_host | default(omit) }}'
                      address: '{{ item.source_address | default(omit) }}'
                      wildcard_bits: '{{ item.source_wildcard_bits | default(omit) }}'
                    destination:
                      any: '{{ item.destination_any | default(omit) }}'
                      host: '{{ item.destination_host | default(omit) }}'
                      address: '{{ item.destination_address | default(omit) }}'
                      wildcard_bits: '{{ item.destination_wildcard_bits | default(omit) }}'
      with_items:
        - "{{ iosrtr_inbound_msdp_sa_filter_acl }}"

    - name: "LOW | CISC-RT-000920 | PATCH | The Cisco Multicast Source Discovery Protocol (MSDP) router must be configured to filter received source-active multicast advertisements for any undesirable multicast groups and sources. | Attach To Each MSDP Peer."
      ios_config:
        lines: ip msdp sa-filter in {{ item.peer_address }} list {{ iosrtr_inbound_msdp_sa_filter_acl_name }}
      with_items:
        - "{{ iosrtr_inbound_msdp_peer_source_active_filter_peer_address }}"
  when:
      - cisc_rt_000920
  tags:
      - CISC-RT-000920
      - CAT2
      - CCI-001368
      - SRG-NET-000018-RTR-000007
      - SV-216635r531085_rule
      - V-216635

- name: "LOW | CISC-RT-000930 | PATCH | The Cisco Multicast Source Discovery Protocol (MSDP) router must be configured to filter source-active multicast advertisements to external MSDP peers to avoid global visibility of local-only multicast sources and groups."
  debug:
    msg: "test"
  when:
      - cisc_rt_000930
  tags:
      - CISC-RT-000930
      - CAT2
      - CCI-001368
      - SRG-NET-000018-RTR-000008
      - SV-216636r531085_rule
      - V-216636

- name: "LOW | CISC-RT-000940 | PATCH | The Cisco Multicast Source Discovery Protocol (MSDP) router must be configured to limit the amount of source-active messages it accepts on a per-peer basis."
  ios_config: 
    lines: ip msdp sa-limit {{ item.msdp_peer | default(omit) }} {{ item.source_active_msg_limit | default(omit) }}
  with_items:
    - "{{ iosrtr_msdp_source_active_msg_per_peers }}"
  when:
      - cisc_rt_000940
  tags:
      - CISC-RT-000940
      - CAT2
      - CCI-001368
      - SRG-NET-000018-RTR-000009
      - SV-216637r531085_rule
      - V-216637

- name: "LOW | CISC-RT-000950 | PATCH | The Cisco Multicast Source Discovery Protocol (MSDP) router must be configured to use a loopback address as the source address when originating MSDP traffic."
  ios_config: 
    lines: ip msdp peer {{ item.msdp_peer | default(omit) }} connect-source {{ item.loopback_interface | default(omit) }} remote-as {{ item.remote_as | default(omit) }}
  with_items:
    - "{{ iosrtr_msdp_packets_sending_loopback_address }}"
  when:
      - cisc_rt_000950
  tags:
      - CISC-RT-000950
      - CAT2
      - CCI-000366
      - SRG-NET-000512-RTR-000011
      - SV-216638r531085_rule
      - V-216638

- name: "LOW | CISC-RT-000470 | PATCH | The Cisco BGP router must be configured to enable the Generalized TTL Security Mechanism (GTSM)."
  ios_config:
    parents:
      - router bgp {{ iosrtr_bgp_as_router_number }} 
    lines:
      - neighbor {{ item.ebgp_neighbor_address }} ttl-security hops {{ item.ttl_security_number_of_hops }}
  with_items:
    - "{{ iosrtr_ebgp_ttl_security_settings }}"
  when:
      - cisc_rt_000470
  tags:
      - CISC-RT-000470
      - CAT2
      - CCI-002385
      - SRG-NET-000362-RTR-000124
      - SV-216991r531085_rule
      - V-216991

- name: "LOW | CISC-RT-000236 | PATCH | The Cisco router must be configured to advertise a hop limit of at least 32 in Router Advertisement messages for IPv6 stateless auto-configuration deployments."
  block:
    - name: "LOW | CISC-RT-000236 | PATCH | The Cisco router must be configured to advertise a hop limit of at least 32 in Router Advertisement messages for IPv6 stateless auto-configuration deployments. | Retrieve Current Ipv6 hop-limit."
      ios_command:
          commands:
            - show running-config | include ipv6 hop-limit
      register: iosrtr_ipv6hoplimit_check

    - name: "LOW | CISC-RT-000236 | PATCH | The Cisco router must be configured to advertise a hop limit of at least 32 in Router Advertisement messages for IPv6 stateless auto-configuration deployments. | Set Fact For Current Limit"
      set_fact:
        iosrtr_ipv6hoplimit_current: "{{ iosrtr_ipv6hoplimit_check.stdout_lines | regex_findall('ipv6 hop-limit .*') | regex_replace('ipv6 hop-limit ', '') | regex_findall('[0-9]+') }}"

    - name: "LOW | CISC-RT-000236 | PATCH | The Cisco router must be configured to advertise a hop limit of at least 32 in Router Advertisement messages for IPv6 stateless auto-configuration deployments. | Change Hop Count"
      ios_config:
        lines:
            - ipv6 hop-limit {{ iosrtr_ipv6_hop_limit }}
      when: 
          - iosrtr_ipv6hoplimit_current|int != iosrtr_ipv6_hop_limit
  when:
      - cisc_rt_000236
      - 
  tags:
      - CISC-RT-000236
      - CAT2
      - CCI-000366
      - SRG-NET-000512-RTR-000012
      - SV-230038r531386_rule
      - V-230038



























- name: Gather Acl Facts
  block:
    - name: Use the ACLs resource module to gather the current config
      ios_acls:

        state: gathered
      register: acls 

    - name: Print ACLs To Screen
      debug:
        msg: "{{ acls }}"

    - name: Create Inventory Directory
      file:
        path: "{{ inventory_dir }}/host_vars/{{ inventory_hostname }}"
        state: directory

    - name: Write ACL Configuration to File
      copy:
        content: "{{ acls | to_nice_yaml }}"
        dest: "{{ inventory_dir }}/host_vars/{{ inventory_hostname }}/acls.yaml"
  when:
      - cisc_rt_acl


- name: Gather BGP Facts
  block:
    - name: Use the bgps resource module to gather the current config
      ios_bgp_global:
        config:
        state: gathered
      register: bgps

    - name: Print bgps To Screen
      debug:
        msg: "{{ bgps }}"

    - name: Create Inventory Directory
      file:
        path: "{{ inventory_dir }}/host_vars/{{ inventory_hostname }}"
        state: directory

    - name: Write bgp Configuration to File
      copy:
        content: "{{ bgps | to_nice_yaml }}"
        dest: "{{ inventory_dir }}/host_vars/{{ inventory_hostname }}/bgp.yaml"
  when:
      - cisc_rt_bgp


- name: Gather Route Maps Facts
  block:
    - name: Use the Route Maps resource module to gather the current config
      ios_route_maps:
        config:
        state: gathered
      register: route_maps

    - name: Print Route Maps To Screen
      debug:
        msg: "{{ route_maps }}"

    - name: Create Inventory Directory
      file:
        path: "{{ inventory_dir }}/host_vars/{{ inventory_hostname }}"
        state: directory

    - name: Write Route Maps Configuration to File
      copy:
        content: "{{ route_maps | to_nice_yaml }}"
        dest: "{{ inventory_dir }}/host_vars/{{ inventory_hostname }}/route_maps.yaml"
  when:
      - cisc_rt_route_maps


- name: Gather Prefix Lists Facts
  block:
    - name: Use the Prefix Lists resource module to gather the current config
      ios_prefix_lists:
        config:
        state: gathered
  when:
      - cisc_rt_prefix_lists

- name: Gather ospf roesources Facts
  block:
    - name: Use the ospf interfaces resource module to gather the current config
      ios_ospfv2:
        config:
        state: gathered
      register: ios_ospfv2

    - name: Print ospf interfaces To Screen
      debug:
        msg: "{{ ios_ospfv2 }}"

    - name: Create Inventory Directory
      file:
        path: "{{ inventory_dir }}/host_vars/{{ inventory_hostname }}"
        state: directory

    - name: Write ospf_resources Configuration to File
      copy:
        content: "{{ ios_ospfv2 | to_nice_yaml }}"
        dest: "{{ inventory_dir }}/host_vars/{{ inventory_hostname }}/ios_ospf_interfaces.yaml"
  when:
      - cisc_rt_ospf_maps

