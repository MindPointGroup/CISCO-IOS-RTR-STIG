---





# ----------------------------------------------------
# CISC-RT-000010
# -------------------------------------------------------
# User Defined Settings In Defaults Main (Used In Full Task)
# -------------------------------------------------------
# iosrtr_external_facing_interfaces_000010 are the External Facing interfaces for the ACL.
# Note: Interfaces that have the ACL attached to it will have it removed if they are not listed below. 
# Example:
#   - "FastEthernet0/0"
#   - "FastEthernet0/1"
iosrtr_external_facing_interfaces_000010:
    - "GigabitEthernet0/0"
    - "FastEthernet2/0"
# -------------------------------------------------------
# User Defined Settings In Defaults Main (Existing ACL)
# -------------------------------------------------------
# iosrtr_filter_server_traffic_acl_000010 is the user defined ACL that is configured to 
# allow or deny traffic for specific source and destination addresses as well as ports and protocols between various subnets as required.
# By default "none" is placed in here, you must change it to your EXACT ACL name, if not there will be a warning displayed at end of run. 
# If using option cisc_rt_hardening_one_device: true make sure to leave none in value.
# If have choosen to use cisc_rt_hardening_one_device: true on the initial run and decide later to srtop using it you 
# must set iosrtr_filter_server_traffic_acl_000010 to the exact EXACT ACL name that was injested from the txt file. 
# Example: "FILTER_SERVER_TRAFFIC"
iosrtr_filter_server_traffic_acl_000010: "FILTER_SERVER_TRAFFIC"
# -------------------------------------------------------
# Single Router Setup (New Setup ACL) 
# -------------------------------------------------------
# The settings below are the name of the old access control list that is used 
# for the FILTER_SERVER_TRAFFIC acl.  
# If you did not have a existing access control list defined in the router leave as is.  
iosrtr_filter_server_traffic_acl_name_old: "none"










- name: "MEDIUM | CISC-RT-000010 | PATCH | The Cisco router must be configured to enforce approved authorizations for controlling the flow of information within the network based on organization-defined information flow control policies."
  block:
      - name: Show Run For Acl Checks Below."
        block:
          - name: Show Run FILTER_SERVER_TRAFFIC ACL."
            ios_command:
              commands:
                - "show run | section ip access-list extended {{ iosrtr_filter_server_traffic_acl_000010 }}"
            register: cisc_rt_000010_acl_showrun_filter_server_traffic

          - name: No ACL Defined Check Block."
            block:
              - name: No ACL Defined Warning Message For FILTER_SERVER_TRAFFIC ACL."
                debug:
                  msg: 
                    - "Warning!!! Review the Access Control Lists (ACLs) Item Is Not Defined."
                    - "To Fix this error please define a existing ACL in iosrtr_ingress_filter_acl_000250 in defaults main."
                when:
                  - "'none' in iosrtr_filter_server_traffic_acl_000010"

              - name: No ACL Defined By That Name Warning FILTER_SERVER_TRAFFIC."
                debug:
                  msg: 
                    - "Warning!!! Review the Access Control Lists(ACLs)."
                    - "The defined ACL {{ iosrtr_filter_server_traffic_acl_000010 }} is not present on the Router."
                when:
                  - "'none' not in iosrtr_filter_server_traffic_acl_000010 and 
                    iosrtr_filter_server_traffic_acl_000010 not in cisc_rt_000010_acl_showrun_filter_server_traffic.stdout | string or
                    ' deny' not in cisc_rt_000010_acl_showrun_filter_server_traffic.stdout_lines | string and 
                    ' permit' not in cisc_rt_000010_acl_showrun_filter_server_traffic.stdout_lines | string"

              - name: Site Policies Warning."
                debug:
                    msg:
                        - "Warning! Below is the Configured ACL For {{ iosrtr_filter_server_traffic_acl_000010 }}"
                        - "Please confirm they align with your site policies to allow or deny traffic for specific"
                        - "source and destination addresses as well as ports and protocols between various subnets as required"
                        - "{{ cisc_rt_000010_acl_showrun_filter_server_traffic.stdout_lines }}"
                when: 
                  - "' deny' in cisc_rt_000010_acl_showrun_filter_server_traffic.stdout_lines | string or
                     ' permit' in cisc_rt_000010_acl_showrun_filter_server_traffic.stdout_lines | string"

          - name: Warn Count Added."
            set_fact:
              control_number: "{{ control_number }} + ['CISC-RT-000010']"
              warn_count: "{{ warn_count|int + 1 }}"
            when:
              - "'none' in iosrtr_filter_server_traffic_acl_000010 or 
                'none' not in iosrtr_filter_server_traffic_acl_000010 and 
                iosrtr_filter_server_traffic_acl_000010 not in cisc_rt_000010_acl_showrun_filter_server_traffic.stdout | string or
                ' deny' not in cisc_rt_000010_acl_showrun_filter_server_traffic.stdout_lines | string and 
                ' permit' not in cisc_rt_000010_acl_showrun_filter_server_traffic.stdout_lines | string or
                ' deny' in cisc_rt_000010_acl_showrun_filter_server_traffic.stdout_lines | string or
                ' permit' in cisc_rt_000010_acl_showrun_filter_server_traffic.stdout_lines | string"

          - name: Attach To Interfaces."
            block:
              - name: Gather Interface Facts."
                ios_interfaces:
                  state: gathered
                register: cisc_rt_000010_interfaceinfo

              - name: Register Show Run With Interfaces."
                ios_command:
                  commands: 
                    - "show run | section {{ item.name }}" 
                with_items: "{{ cisc_rt_000010_interfaceinfo.gathered }}"
                register: cisc_rt_000010_interfaceinfo_showrun

              - name: Set Fact For Interface Name And Stdout." 
                set_fact:
                  cisc_rt_000010_intname: "{{ cisc_rt_000010_interfaceinfo_showrun.results | map(attribute='item.name') }}"
                  cisc_rt_000010_intstdout: "{{ cisc_rt_000010_interfaceinfo_showrun.results | map(attribute='stdout') }}"

              - name: Add ACL To Interfaces Listed In iosrtr_external_facing_interfaces_000010."
                ios_config:
                  parents:
                    - "interface {{ item.0 }}"
                  lines:
                    - "ip access-group {{ iosrtr_filter_server_traffic_acl_000010 }} in"
                with_together: 
                  - "{{ cisc_rt_000010_intname }}"
                  - "{{ cisc_rt_000010_intstdout }}"
                when:
                  - item.0 in iosrtr_external_facing_interfaces_000010
                  - iosrtr_filter_server_traffic_acl_000010 not in item.1

              - name: Remove ACL From Interfaces Not Listed In iosrtr_external_facing_interfaces_000010."
                ios_config:
                  parents:
                    - "interface {{ item.0 }}"
                  lines:
                    - "no ip access-group {{ iosrtr_filter_perimeter_acl_000250 }} in"
                with_together: 
                  - "{{ cisc_rt_000010_intname }}"
                  - "{{ cisc_rt_000010_intstdout }}"
                when:
                  - item.0 not in iosrtr_external_facing_interfaces_000010
                  - iosrtr_filter_server_traffic_acl_000010 in item.1

              - name: Remove Old Filter Server ACL From All Interfaces On Router."
                ios_config:
                  parents:
                    - "interface {{ item.0 }}"
                  lines:
                    - "no ip access-group {{ iosrtr_filter_server_traffic_acl_name_old }} in"
                with_together: 
                  - "{{ cisc_rt_000010_intname }}"
                  - "{{ cisc_rt_000010_intstdout }}"
                when:
                  - "'none' not in iosrtr_filter_server_traffic_acl_name_old"
                  - item.0 is defined
                  - iosrtr_filter_server_traffic_acl_name_old in item.1
        when:
          - not cisc_rt_hardening_one_device

      - name: Single Router Setup."
        block:
          - name: Remove Old Filter Server Access List."
            ios_acls:
                config:
                    - afi: ipv4
                      acls:
                        - name: "{{ iosrtr_filter_server_traffic_acl_name_old }}"
                state: deleted
            when: 
              - "'none' not in iosrtr_filter_server_traffic_acl_name_old"

          - name: Parse User Given ACL From host_vars For Filter Server Access List."
            ios_acls:
              running_config: "{{ lookup('file','files/cisc-rt-000010-acl.txt') }}"
              state: parsed
            register: cisc_rt_000010_filter_server_traffic_parsed

          - name:  Convert JSON to DICT For ACL Defined Name For Filter Server Access List."
            set_fact:
              cisc_rt_000010_filter_server_traffic_name: "{{ cisc_rt_000010_filter_server_traffic_parsed.parsed.0.acls.0.name }}"
          
          - name: Compare And Update ACL For FILTER_SERVER_TRAFFIC ACL."
            ios_acls:
              config: "{{ cisc_rt_000010_filter_server_traffic_parsed.parsed }}"
              state: replaced
            register: cisc_rt_000250_filter_server_traffic_ran

          - name: Print Changed Lines With Debug When ACL Is Changed For Filter Server Traffic Access List."
            debug:
              var: cisc_rt_000250_filter_server_traffic_ran.commands
            when: 
              - cisc_rt_000250_filter_server_traffic_ran.changed

          - name: Check Against Site Policies And Warn Count."
            block:
              - name: Show Run FILTER_SERVER_TRAFFIC ACL."
                ios_command:
                  commands:
                    - "show run | section ip access-list extended {{ cisc_rt_000010_filter_server_traffic_name }}"
                register: cisc_rt_000010_acl_showrun_filter_server_traffic

              - name: Site Policies Warning."
                debug:
                    msg:
                        - "Warning! Below is the Configured ACL For {{ cisc_rt_000010_filter_server_traffic_name }}"
                        - "Please confirm they align with your site policies to allow or deny traffic for specific"
                        - "source and destination addresses as well as ports and protocols between various subnets as required"
                        - "{{ cisc_rt_000010_acl_showrun_filter_server_traffic.stdout_lines }}"
                when: 
                  - "' deny' in cisc_rt_000010_acl_showrun_filter_server_traffic.stdout_lines | string or
                     ' permit' in cisc_rt_000010_acl_showrun_filter_server_traffic.stdout_lines | string"

              - name: Warn Count Added."
                set_fact:
                  control_number: "{{ control_number }} + ['CISC-RT-000010']"
                  warn_count: "{{ warn_count|int + 1 }}"
                when: 
                  - "' deny' in cisc_rt_000010_acl_showrun_filter_server_traffic.stdout_lines | string or
                     ' permit' in cisc_rt_000010_acl_showrun_filter_server_traffic.stdout_lines | string"

          - name: Add To Interfaces Block."
            block: 
              - name: Gather Interface Facts."
                ios_interfaces:
                  state: gathered
                register: cisc_rt_000010_interfaceinfo

              - name: Register Show Run With Interfaces."
                ios_command:
                  commands: 
                    - "show run | section {{ item.name }}" 
                with_items: "{{ cisc_rt_000010_interfaceinfo.gathered }}"
                register: cisc_rt_000010_interfaceinfo_showrun

              - name: Set Fact For Interface Name And Stdout." 
                set_fact:
                  cisc_rt_000010_intname: "{{ cisc_rt_000010_interfaceinfo_showrun.results | map(attribute='item.name') }}"
                  cisc_rt_000010_intstdout: "{{ cisc_rt_000010_interfaceinfo_showrun.results | map(attribute='stdout') }}"

              - name: Add ACL To Interfaces Listed In iosrtr_external_facing_interfaces_000010."
                ios_config:
                  parents:
                    - "interface {{ item.0 }}"
                  lines:
                    - "ip access-group {{ cisc_rt_000010_filter_server_traffic_name }} in"
                with_together: 
                  - "{{ cisc_rt_000010_intname }}"
                  - "{{ cisc_rt_000010_intstdout }}"
                when:
                  - item.0 in iosrtr_external_facing_interfaces_000010
                  - cisc_rt_000010_filter_server_traffic_name not in item.1

              - name: Remove ACL From Interfaces Not Listed In iosrtr_external_facing_interfaces_000010."
                ios_config:
                  parents:
                    - "interface {{ item.0 }}"
                  lines:
                    - "no ip access-group {{ cisc_rt_000010_filter_server_traffic_name }} in"
                with_together: 
                  - "{{ cisc_rt_000010_intname }}"
                  - "{{ cisc_rt_000010_intstdout }}"
                when:
                  - item.0 not in iosrtr_external_facing_interfaces_000010
                  - cisc_rt_000010_filter_server_traffic_name in item.1

              - name: Remove Old Filter Server Traffic From All Interfaces On Router."
                ios_config:
                  parents:
                    - "interface {{ item.0 }}"
                  lines:
                    - "no ip access-group {{ iosrtr_filter_server_traffic_acl_name_old }} in"
                with_together: 
                  - "{{ cisc_rt_000010_intname }}"
                  - "{{ cisc_rt_000010_intstdout }}"
                when:
                  - "'none' not in iosrtr_filter_server_traffic_acl_name_old"
                  - item.0 is defined
                  - iosrtr_filter_server_traffic_acl_name_old in item.1
        when: 
          - cisc_rt_hardening_one_device
          - "'none' in iosrtr_filter_server_traffic_acl_000010"
  when:
      - cisc_rt_000010
      - not cisc_rt_dodin_backbone
  tags:
      - CISC-RT-000010
      - CAT2
      - CCI-001368
      - SRG-NET-000018-RTR-000001
      - SV-216551r531085_rule
      - V-216551
